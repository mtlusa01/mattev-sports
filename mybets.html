<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Bets | Edge Factor Elite</title>
  <meta name="description" content="Track your bets and view your betting history with Edge Factor Elite.">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #111118;
      --bg-tertiary: #1a1a24;
      --bg-elevated: rgba(37, 37, 50, 0.5);
      --border: rgba(255, 255, 255, 0.08);
      --border-light: rgba(255, 255, 255, 0.12);
      --text-primary: #f0f0f0;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --brand: #dc2626;
      --brand-light: #ef4444;
      --brand-glow: rgba(220, 38, 38, 0.15);
      --brand-border: rgba(220, 38, 38, 0.3);
      --accent: #10b981;
      --accent-light: #34d399;
      --accent-glow: rgba(16, 185, 129, 0.15);
      --red: #ef4444;
      --red-light: #f87171;
      --yellow: #f59e0b;
      --blue: #3b82f6;
      --purple: #8b5cf6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    .page-gradient {
      position: fixed; top: 0; left: 0; right: 0; height: 60vh;
      background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(220, 38, 38, 0.08), transparent);
      pointer-events: none; z-index: 0;
    }

    /* ── Top Nav ── */
    .top-nav {
      background: var(--bg-primary);
      position: fixed; top: 0; left: 0; right: 0; height: 60px; z-index: 100;
      display: flex; align-items: center;
      border-bottom: 1px solid var(--border);
    }
    .top-nav-inner {
      max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: space-between;
    }
    .logo { display: flex; align-items: center; gap: 0.75rem; text-decoration: none; }
    .brand-logo-circle {
      width: 44px; height: 44px; border-radius: 50%; overflow: hidden;
      border: 2px solid var(--brand); box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
      transition: all 0.2s;
    }
    .brand-logo-img { width: 100%; height: 100%; object-fit: cover; }
    .brand-name { font-size: 1.15rem; font-weight: 700; color: var(--text-primary); letter-spacing: -0.02em; }
    .brand-name .brand-elite { color: var(--brand-light); font-weight: 800; }
    .logo:hover .brand-logo-circle { border-color: var(--brand-light); transform: scale(1.05); }
    .nav-right { display: flex; align-items: center; gap: 1.5rem; }
    .nav-link { color: #a0a0a0; text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: color 0.2s; }
    .nav-link:hover { color: #ffffff; }
    .nav-link.active { color: var(--brand-light); }

    /* ── Main Container ── */
    .main-container {
      max-width: 900px; margin: 0 auto; padding: 80px 1.5rem 2rem;
      position: relative; z-index: 1;
    }

    /* ── Top Stats Row ── */
    .top-bar {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; flex-wrap: wrap; gap: 12px;
    }
    .stats-row {
      display: flex; gap: 16px; flex-wrap: wrap;
    }
    .stat-pill {
      display: flex; flex-direction: column; align-items: center;
      background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px;
      padding: 12px 20px; min-width: 100px;
    }
    .stat-pill-value { font-size: 1.5rem; font-weight: 700; line-height: 1.2; }
    .stat-pill-value.positive { color: var(--accent); }
    .stat-pill-value.negative { color: var(--red-light); }
    .stat-pill-value.neutral { color: var(--text-primary); }
    .stat-pill-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-top: 2px; }

    .display-toggle {
      display: flex; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; overflow: hidden;
    }
    .display-toggle button {
      padding: 8px 16px; border: none; background: transparent; color: var(--text-secondary);
      font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s;
    }
    .display-toggle button:hover { color: var(--text-primary); }
    .display-toggle button.active { background: var(--accent); color: #fff; }

    /* ── Quick Filters ── */
    .quick-filters {
      display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;
    }
    .quick-btn {
      padding: 10px 20px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--bg-secondary); color: var(--text-secondary); font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all 0.15s;
    }
    .quick-btn:hover { border-color: var(--border-light); color: var(--text-primary); }
    .quick-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

    /* ── Calendar ── */
    .calendar-card {
      background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px;
      padding: 24px; margin-bottom: 24px;
    }
    .calendar-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
    }
    .calendar-title { font-size: 20px; font-weight: 700; }
    .calendar-nav { display: flex; gap: 8px; }
    .calendar-nav button {
      width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--bg-tertiary); color: var(--text-secondary); cursor: pointer;
      font-size: 18px; transition: all 0.15s; display: flex; align-items: center; justify-content: center;
    }
    .calendar-nav button:hover { border-color: var(--border-light); color: var(--text-primary); background: var(--bg-elevated); }

    .calendar-weekdays {
      display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px;
    }
    .calendar-weekday {
      text-align: center; font-size: 12px; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; padding: 8px 0;
    }

    .calendar-grid {
      display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;
    }
    .calendar-day {
      aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 15px; font-weight: 500; color: var(--text-secondary); border-radius: 12px; cursor: pointer;
      position: relative; transition: all 0.15s; border: 2px solid transparent;
      min-height: 48px;
    }
    .calendar-day:hover { background: var(--bg-tertiary); }
    .calendar-day.other-month { color: rgba(107, 114, 128, 0.25); }
    .calendar-day.other-month:hover { background: transparent; cursor: default; }
    .calendar-day.today { border-color: var(--border-light); font-weight: 700; color: var(--text-primary); }
    .calendar-day.selected { background: var(--accent); color: #fff; border-color: var(--accent); }
    .calendar-day.selected:hover { background: var(--accent-light); }
    .calendar-day.has-bets { font-weight: 600; color: var(--text-primary); }
    .calendar-day.future { color: rgba(107, 114, 128, 0.15); cursor: default; }
    .calendar-day.future:hover { background: transparent; }
    .calendar-day.win-day { background: rgba(16, 185, 129, 0.15); }
    .calendar-day.loss-day { background: rgba(239, 68, 68, 0.15); }
    .calendar-day.mixed-day { background: rgba(245, 158, 11, 0.15); }
    .calendar-day.pending-day { background: rgba(107, 114, 128, 0.1); }

    .calendar-dot {
      position: absolute; bottom: 6px; width: 6px; height: 6px; border-radius: 50%;
    }
    .calendar-dot.win { background: var(--accent); }
    .calendar-dot.loss { background: var(--red); }
    .calendar-dot.mixed { background: var(--yellow); }
    .calendar-dot.pending { background: var(--text-muted); }

    /* ── Monthly Summary ── */
    .month-summary {
      display: flex; justify-content: space-between; align-items: center;
      padding-top: 20px; margin-top: 20px; border-top: 1px solid var(--border);
      flex-wrap: wrap; gap: 16px;
    }
    .month-stat {
      display: flex; flex-direction: column; align-items: center; min-width: 80px;
    }
    .month-stat-value { font-size: 18px; font-weight: 700; }
    .month-stat-value.positive { color: var(--accent); }
    .month-stat-value.negative { color: var(--red-light); }
    .month-stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-top: 2px; }

    .win-rate-bar {
      flex: 1; max-width: 200px; min-width: 120px;
    }
    .win-rate-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; text-align: center; }
    .win-rate-track {
      height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;
      display: flex;
    }
    .win-rate-fill { height: 100%; background: var(--accent); transition: width 0.3s; }
    .win-rate-fill.loss { background: var(--red); }
    .win-rate-value { font-size: 14px; font-weight: 700; text-align: center; margin-top: 4px; }

    /* ── Bets Section ── */
    .bets-section {
      margin-top: 24px;
    }
    .bets-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
    }
    .bets-title { font-size: 16px; font-weight: 600; color: var(--text-secondary); }
    .bets-filter-row {
      display: flex; gap: 8px; align-items: center;
    }
    .filter-btn {
      padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border);
      background: transparent; color: var(--text-muted); font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.15s;
    }
    .filter-btn:hover { border-color: var(--border-light); color: var(--text-primary); }
    .filter-btn.active { background: var(--brand); border-color: var(--brand); color: #fff; }
    .filter-btn.active-green { background: var(--accent); border-color: var(--accent); color: #fff; }
    .filter-btn.active-red { background: var(--red); border-color: var(--red); color: #fff; }

    .grading-status {
      font-size: 11px; color: var(--text-muted); padding: 4px 10px;
      background: var(--bg-tertiary); border-radius: 6px;
    }
    .grading-status.grading { color: var(--yellow); }

    .clear-btn {
      padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border);
      background: transparent; color: var(--text-muted); font-size: 12px; font-weight: 500;
      cursor: pointer; transition: all 0.15s;
    }
    .clear-btn:hover { border-color: var(--red); color: var(--red-light); }

    /* ── Bets Table ── */
    .bets-table-container {
      background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px;
      overflow: hidden;
    }
    .bets-table {
      width: 100%; border-collapse: collapse;
    }
    .bets-table th {
      text-align: left; padding: 12px 14px; font-size: 11px; font-weight: 600;
      color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border); background: var(--bg-tertiary);
    }
    .bets-table td {
      padding: 12px 14px; border-bottom: 1px solid var(--border); font-size: 13px;
      vertical-align: middle;
    }
    .bets-table tr:last-child td { border-bottom: none; }
    .bets-table tr:hover { background: rgba(255,255,255,0.02); }

    .bet-pick { font-weight: 600; color: var(--text-primary); }
    .bet-game { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .bet-type { font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
    .bet-type.prop { background: rgba(139, 92, 246, 0.2); color: var(--purple); }
    .bet-type.spread { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
    .bet-type.total { background: rgba(245, 158, 11, 0.2); color: var(--yellow); }
    .bet-type.ml { background: rgba(16, 185, 129, 0.2); color: var(--accent); }

    .bet-status { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 4px; }
    .bet-status.pending { background: rgba(107, 114, 128, 0.2); color: var(--text-secondary); }
    .bet-status.win { background: rgba(16, 185, 129, 0.2); color: var(--accent); }
    .bet-status.loss { background: rgba(239, 68, 68, 0.2); color: var(--red-light); }
    .bet-status.push { background: rgba(245, 158, 11, 0.2); color: var(--yellow); }

    .bet-profit { font-weight: 600; font-size: 13px; }
    .bet-profit.positive { color: var(--accent); }
    .bet-profit.negative { color: var(--red-light); }
    .bet-profit.neutral { color: var(--text-muted); }

    .bet-delete {
      background: none; border: none; color: var(--text-muted); cursor: pointer;
      font-size: 14px; padding: 4px 8px; opacity: 0.4; transition: all 0.15s;
    }
    .bet-delete:hover { opacity: 1; color: var(--red-light); }

    .empty-state {
      text-align: center; padding: 48px 20px; color: var(--text-muted);
    }
    .empty-state-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state-title { font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
    .empty-state-text { font-size: 13px; }
    .empty-state a { color: var(--brand-light); text-decoration: none; }
    .empty-state a:hover { text-decoration: underline; }

    /* ── Settings Card ── */
    .settings-card {
      background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px;
      padding: 20px; margin-top: 24px;
    }
    .settings-title { font-size: 13px; font-weight: 600; margin-bottom: 12px; color: var(--text-muted); }
    .settings-row {
      display: flex; align-items: center; gap: 12px;
    }
    .settings-label { font-size: 13px; color: var(--text-secondary); }
    .settings-input {
      padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border);
      background: var(--bg-primary); color: var(--text-primary); font-size: 14px; width: 100px;
    }
    .settings-input:focus { outline: none; border-color: var(--brand-border); }

    /* ── Mobile ── */
    @media (max-width: 768px) {
      .nav-right { display: none; }
      .top-bar { flex-direction: column; align-items: stretch; }
      .stats-row { justify-content: space-between; }
      .stat-pill { flex: 1; min-width: 70px; padding: 10px 12px; }
      .stat-pill-value { font-size: 1.25rem; }
      .display-toggle { align-self: flex-end; }
      .calendar-day { min-height: 40px; font-size: 13px; }
      .calendar-day .calendar-dot { bottom: 4px; width: 5px; height: 5px; }
      .month-summary { justify-content: center; }
      .bets-table th, .bets-table td { padding: 10px 10px; font-size: 12px; }
      .col-hide-mobile { display: none; }
      .quick-filters { justify-content: center; }
    }

    /* ── Confirm Modal ── */
    .confirm-modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200;
      opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s;
      display: flex; align-items: center; justify-content: center;
    }
    .confirm-modal-backdrop.visible { opacity: 1; visibility: visible; }
    .confirm-modal {
      width: calc(100% - 32px); max-width: 400px; background: var(--bg-secondary);
      border: 1px solid var(--border); border-radius: 16px; padding: 24px;
      text-align: center; transform: scale(0.95); transition: transform 0.2s;
    }
    .confirm-modal-backdrop.visible .confirm-modal { transform: scale(1); }
    .confirm-modal-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; }
    .confirm-modal-text { font-size: 14px; color: var(--text-secondary); margin-bottom: 24px; }
    .confirm-modal-actions { display: flex; gap: 12px; }
    .confirm-btn {
      flex: 1; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none;
    }
    .confirm-btn.cancel { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border); }
    .confirm-btn.cancel:hover { background: var(--bg-elevated); }
    .confirm-btn.danger { background: var(--red); color: #fff; }
    .confirm-btn.danger:hover { background: #dc2626; }

    /* ── Sync Status Indicator ── */
    .sync-status {
      position: fixed; top: 70px; right: 20px; z-index: 50;
      display: flex; align-items: center; gap: 6px;
      font-size: 11px; color: var(--text-muted);
      background: var(--bg-secondary); border: 1px solid var(--border);
      padding: 6px 12px; border-radius: 20px;
      opacity: 0; transition: opacity 0.3s;
    }
    .sync-status.visible { opacity: 1; }
    .sync-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); }
    .sync-indicator.syncing { background: var(--yellow); animation: pulse 1s infinite; }
    .sync-indicator.error { background: var(--red); }
    .sync-indicator.offline { background: var(--text-muted); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    .login-prompt {
      background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px;
      padding: 20px; margin-bottom: 20px; text-align: center;
    }
    .login-prompt-text { font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; }
    .login-prompt-btn {
      display: inline-block; padding: 10px 24px; background: var(--brand); color: #fff;
      border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;
      transition: background 0.2s;
    }
    .login-prompt-btn:hover { background: var(--brand-light); }
  </style>
</head>
<body>
  <div class="page-gradient"></div>

  <nav class="top-nav">
    <div class="top-nav-inner">
      <a href="dashboard.html" class="logo">
        <div class="brand-logo-circle">
          <img src="logo.png" alt="EFE" class="brand-logo-img" onerror="this.style.display='none'">
        </div>
        <span class="brand-name">Edge Factor <span class="brand-elite">Elite</span></span>
      </a>
      <div class="nav-right">
        <a href="dashboard.html" class="nav-link">Dashboard</a>
        <a href="results.html" class="nav-link">Results</a>
        <a href="mybets.html" class="nav-link active">My Bets</a>
        <a href="about.html" class="nav-link">About</a>
      </div>
    </div>
  </nav>

  <!-- Sync Status Indicator -->
  <div class="sync-status" id="sync-status">
    <span class="sync-indicator" id="sync-indicator"></span>
    <span id="sync-text">Synced</span>
  </div>

  <!-- Login Prompt (shown when not logged in) -->
  <div class="login-prompt" id="login-prompt" style="display: none;">
    <div class="login-prompt-text">Log in to sync your bets across all devices</div>
    <a href="login.html" class="login-prompt-btn">Log In</a>
  </div>

  <main class="main-container">
    <!-- Top Stats Row -->
    <div class="top-bar">
      <div class="stats-row" id="stats-row"></div>
      <div class="display-toggle">
        <button id="toggle-units" class="active" onclick="setDisplayMode('units')">Units</button>
        <button id="toggle-dollars" onclick="setDisplayMode('dollars')">Dollars</button>
      </div>
    </div>

    <!-- Quick Filters -->
    <div class="quick-filters">
      <button class="quick-btn active" data-range="today" onclick="selectRange('today')">Today</button>
      <button class="quick-btn" data-range="week" onclick="selectRange('week')">This Week</button>
      <button class="quick-btn" data-range="month" onclick="selectRange('month')">This Month</button>
      <button class="quick-btn" data-range="all" onclick="selectRange('all')">All Time</button>
    </div>

    <!-- Calendar -->
    <div class="calendar-card">
      <div class="calendar-header">
        <span class="calendar-title" id="calendar-title">February 2026</span>
        <div class="calendar-nav">
          <button onclick="navMonth(-1)">&#8249;</button>
          <button onclick="navMonth(1)">&#8250;</button>
        </div>
      </div>
      <div class="calendar-weekdays">
        <div class="calendar-weekday">S</div>
        <div class="calendar-weekday">M</div>
        <div class="calendar-weekday">T</div>
        <div class="calendar-weekday">W</div>
        <div class="calendar-weekday">T</div>
        <div class="calendar-weekday">F</div>
        <div class="calendar-weekday">S</div>
      </div>
      <div class="calendar-grid" id="calendar-grid"></div>
      <div class="month-summary" id="month-summary"></div>
    </div>

    <!-- Bets Section -->
    <div class="bets-section">
      <div class="bets-header">
        <span class="bets-title" id="bets-title">Today's Bets</span>
        <div class="bets-filter-row">
          <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
          <button class="filter-btn" data-filter="pending" onclick="setFilter('pending')">Pending</button>
          <button class="filter-btn" data-filter="win" onclick="setFilter('win')">Wins</button>
          <button class="filter-btn" data-filter="loss" onclick="setFilter('loss')">Losses</button>
          <span class="grading-status" id="grading-status"></span>
          <button class="clear-btn" onclick="showClearConfirm()">Clear</button>
        </div>
      </div>
      <div class="bets-table-container" id="bets-container"></div>
    </div>

    <!-- Settings -->
    <div class="settings-card">
      <div class="settings-title">Settings</div>
      <div class="settings-row">
        <span class="settings-label">Unit Size</span>
        <input type="number" class="settings-input" id="unit-size" value="10" min="1" onchange="saveSettings()">
        <span class="settings-label">dollars</span>
      </div>
    </div>
  </main>

  <!-- Confirm Modal -->
  <div class="confirm-modal-backdrop" id="confirm-backdrop" onclick="hideConfirm()">
    <div class="confirm-modal" onclick="event.stopPropagation()">
      <div class="confirm-modal-title" id="confirm-title">Clear All Bets?</div>
      <div class="confirm-modal-text" id="confirm-text">This will permanently delete all tracked bets.</div>
      <div class="confirm-modal-actions">
        <button class="confirm-btn cancel" onclick="hideConfirm()">Cancel</button>
        <button class="confirm-btn danger" onclick="confirmClearAll()">Clear</button>
      </div>
    </div>
  </div>

  <script>
    // ── Firebase Config ──
    const firebaseConfig = {
      apiKey: "AIzaSyBZtHCHKutZzbQXgwUPfOfJvCtbQh3e-r4",
      authDomain: "edge-factor-elite.firebaseapp.com",
      projectId: "edge-factor-elite",
      storageBucket: "edge-factor-elite.firebasestorage.app",
      messagingSenderId: "469124201044",
      appId: "1:469124201044:web:d1466e2b198db6d7df4bc1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ── Constants ──
    const LS_SETTINGS = 'efe_user_settings';
    const LS_BETS = 'efe_tracked_bets';
    const LS_LAST_SYNC = 'efe_last_sync';
    const GAME_DATA_URL = 'https://raw.githubusercontent.com/mtlusa01/mattev-sports/main/game_projections.json';
    const NHL_GAME_DATA_URL = 'https://raw.githubusercontent.com/mtlusa01/mattev-sports/main/nhl_game_projections.json';
    const RESULTS_URL = 'https://raw.githubusercontent.com/mtlusa01/mattev-sports/main/results.json';
    const NHL_RESULTS_URL = 'https://raw.githubusercontent.com/mtlusa01/mattev-sports/main/nhl_results.json';
    const MONTH_NAMES = ['January','February','March','April','May','June',
                         'July','August','September','October','November','December'];

    // ── State ──
    let displayMode = 'units'; // 'units' or 'dollars'
    let currentFilter = 'all';
    let dateRangeMode = 'today'; // 'today', 'week', 'month', 'all', 'single'
    let selectedDate = null;
    let calViewMonth = new Date().getMonth();
    let calViewYear = new Date().getFullYear();
    let gameProjections = [];
    let nhlGameProjections = [];
    let resultsData = null;
    let nhlResultsData = null;
    let currentUser = null;
    let isSyncing = false;
    let syncDebounceTimer = null;

    // ── Helpers ──
    function getBetSettings() {
      try { return JSON.parse(localStorage.getItem(LS_SETTINGS)) || {}; }
      catch { return {}; }
    }
    function saveBetSettings(s) { localStorage.setItem(LS_SETTINGS, JSON.stringify(s)); }
    function getTrackedBets() {
      try { return JSON.parse(localStorage.getItem(LS_BETS)) || []; }
      catch { return []; }
    }
    function saveTrackedBets(bets, skipSync = false) {
      localStorage.setItem(LS_BETS, JSON.stringify(bets));
      if (!skipSync && currentUser) {
        debouncedSyncToCloud();
      }
    }
    function getUnitSize() { return getBetSettings().unit_size || 10; }

    // ══════════════════════════════════════════
    // CLOUD SYNC FUNCTIONS
    // ══════════════════════════════════════════

    function updateSyncStatus(status, text) {
      const statusEl = document.getElementById('sync-status');
      const indicator = document.getElementById('sync-indicator');
      const textEl = document.getElementById('sync-text');

      indicator.className = 'sync-indicator';
      if (status === 'syncing') indicator.classList.add('syncing');
      else if (status === 'error') indicator.classList.add('error');
      else if (status === 'offline') indicator.classList.add('offline');

      textEl.textContent = text || 'Synced';
      statusEl.classList.add('visible');

      // Hide after 3 seconds unless syncing
      if (status !== 'syncing') {
        setTimeout(() => statusEl.classList.remove('visible'), 3000);
      }
    }

    function debouncedSyncToCloud() {
      if (syncDebounceTimer) clearTimeout(syncDebounceTimer);
      syncDebounceTimer = setTimeout(() => syncBetsToCloud(), 1000);
    }

    async function syncBetsToCloud() {
      if (!currentUser || isSyncing) return;
      isSyncing = true;
      updateSyncStatus('syncing', 'Syncing...');

      try {
        const localBets = getTrackedBets();

        // Ensure all bets have IDs
        for (const bet of localBets) {
          if (!bet.id) {
            bet.id = 'bet_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          }
        }

        // Store bets as a field in the user document (not subcollection)
        // This works with existing Firestore security rules
        await db.collection('users').doc(currentUser.uid).update({
          trackedBets: localBets,
          lastBetSync: firebase.firestore.FieldValue.serverTimestamp()
        });

        localStorage.setItem(LS_LAST_SYNC, new Date().toISOString());
        updateSyncStatus('synced', 'Synced');
        console.log('Synced', localBets.length, 'bets to cloud');

      } catch (error) {
        console.error('Cloud sync failed:', error);
        // If update fails (field doesn't exist), try set with merge
        try {
          await db.collection('users').doc(currentUser.uid).set({
            trackedBets: getTrackedBets(),
            lastBetSync: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          updateSyncStatus('synced', 'Synced');
        } catch (retryError) {
          console.error('Retry failed:', retryError);
          updateSyncStatus('error', 'Sync failed');
        }
      } finally {
        isSyncing = false;
      }
    }

    async function syncBetsFromCloud() {
      if (!currentUser) return;
      updateSyncStatus('syncing', 'Loading...');

      try {
        // Read bets from user document field
        const userDoc = await db.collection('users').doc(currentUser.uid).get();

        if (!userDoc.exists) {
          console.log('No user document found');
          updateSyncStatus('synced', 'Synced');
          return;
        }

        const userData = userDoc.data();
        const cloudBets = userData.trackedBets || [];
        const localBets = getTrackedBets();

        // Merge cloud and local bets
        const mergedBets = mergeBets(localBets, cloudBets);

        // Save merged bets locally (skip sync to avoid loop)
        saveTrackedBets(mergedBets, true);

        console.log(`Synced: ${cloudBets.length} cloud + ${localBets.length} local = ${mergedBets.length} merged`);
        updateSyncStatus('synced', 'Synced');

        // Re-render with synced data
        renderStats();
        renderBets();
        renderCalendar();

      } catch (error) {
        console.error('Failed to sync from cloud:', error);
        updateSyncStatus('error', 'Load failed');
      }
    }

    function mergeBets(localBets, cloudBets) {
      const betMap = new Map();

      // Create unique key for each bet
      function getBetKey(bet) {
        if (bet.id) return bet.id;
        // Fallback key for bets without ID
        return `${bet.game || ''}_${bet.pick || ''}_${bet.date || ''}_${bet.type || ''}`;
      }

      // Add cloud bets first
      for (const bet of cloudBets) {
        const key = getBetKey(bet);
        betMap.set(key, bet);
      }

      // Add/update with local bets (local takes precedence if newer or has updates)
      for (const bet of localBets) {
        const key = getBetKey(bet);
        const existing = betMap.get(key);

        if (!existing) {
          betMap.set(key, bet);
        } else {
          // Compare timestamps - prefer newer
          const localTime = bet.placed_at ? new Date(bet.placed_at).getTime() : 0;
          const cloudTime = existing.placed_at ? new Date(existing.placed_at).getTime() : 0;

          // If local is newer or has graded status, prefer local
          if (localTime > cloudTime ||
              (bet.status !== 'pending' && existing.status === 'pending')) {
            betMap.set(key, bet);
          }
        }
      }

      return Array.from(betMap.values());
    }

    function showLoginPrompt(show) {
      const prompt = document.getElementById('login-prompt');
      if (prompt) prompt.style.display = show ? 'block' : 'none';
    }

    function getLocalDateStr() {
      const now = new Date();
      return now.getFullYear() + '-' +
        String(now.getMonth() + 1).padStart(2, '0') + '-' +
        String(now.getDate()).padStart(2, '0');
    }

    function calcProfit(odds, units) {
      const o = parseInt(odds);
      if (isNaN(o)) return 0;
      if (o > 0) return units * (o / 100);
      return units * (100 / Math.abs(o));
    }

    function formatDateLabel(dateStr) {
      const today = getLocalDateStr();
      const d = new Date(dateStr + 'T12:00:00');
      if (dateStr === today) return 'Today';
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      if (dateStr === yesterday.toISOString().slice(0, 10)) return 'Yesterday';
      return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    // ── Display Mode ──
    function setDisplayMode(mode) {
      displayMode = mode;
      document.getElementById('toggle-units').classList.toggle('active', mode === 'units');
      document.getElementById('toggle-dollars').classList.toggle('active', mode === 'dollars');
      const settings = getBetSettings();
      settings.display_mode = mode;
      saveBetSettings(settings);
      renderStats();
      renderBets();
      renderMonthSummary();
    }

    // ── Date Range ──
    function selectRange(range) {
      dateRangeMode = range;
      selectedDate = range === 'today' ? getLocalDateStr() : null;
      document.querySelectorAll('.quick-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.range === range);
      });
      updateBetsTitle();
      renderStats();
      renderBets();
      renderCalendar();
      if (range === 'today') autoGradeBets();
    }

    function selectCalendarDate(dateStr) {
      selectedDate = dateStr;
      dateRangeMode = 'single';
      document.querySelectorAll('.quick-btn').forEach(btn => btn.classList.remove('active'));
      updateBetsTitle();
      renderStats();
      renderBets();
      renderCalendar();
      autoGradeBets();
    }

    function updateBetsTitle() {
      let title = 'All Bets';
      if (dateRangeMode === 'today') title = "Today's Bets";
      else if (dateRangeMode === 'week') title = "This Week's Bets";
      else if (dateRangeMode === 'month') title = MONTH_NAMES[new Date().getMonth()] + ' Bets';
      else if (dateRangeMode === 'all') title = 'All Time Bets';
      else if (dateRangeMode === 'single' && selectedDate) title = formatDateLabel(selectedDate) + ' Bets';
      document.getElementById('bets-title').textContent = title;
    }

    // ── Get Bets for Display ──
    function getBetsForDisplay() {
      const bets = getTrackedBets();
      const today = getLocalDateStr();

      if (dateRangeMode === 'all') return bets;

      if (dateRangeMode === 'today') {
        return bets.filter(b => {
          const date = b.date || (b.placed_at ? b.placed_at.slice(0, 10) : null);
          return date === today;
        });
      }

      if (dateRangeMode === 'week') {
        const now = new Date();
        const dayOfWeek = now.getDay();
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - dayOfWeek);
        const weekStartStr = weekStart.toISOString().slice(0, 10);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        const weekEndStr = weekEnd.toISOString().slice(0, 10);

        return bets.filter(b => {
          const date = b.date || (b.placed_at ? b.placed_at.slice(0, 10) : null);
          return date && date >= weekStartStr && date <= weekEndStr;
        });
      }

      if (dateRangeMode === 'month') {
        const now = new Date();
        const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        return bets.filter(b => {
          const date = b.date || (b.placed_at ? b.placed_at.slice(0, 10) : null);
          return date && date.startsWith(monthKey);
        });
      }

      if (dateRangeMode === 'single' && selectedDate) {
        return bets.filter(b => {
          const date = b.date || (b.placed_at ? b.placed_at.slice(0, 10) : null);
          return date === selectedDate;
        });
      }

      return bets;
    }

    function getBetsByDate() {
      const bets = getTrackedBets();
      const byDate = {};
      for (const b of bets) {
        const date = b.date || (b.placed_at ? b.placed_at.slice(0, 10) : null);
        if (!date) continue;
        if (!byDate[date]) byDate[date] = { wins: 0, losses: 0, pending: 0, pushes: 0, profit: 0 };
        if (b.status === 'win') byDate[date].wins++;
        else if (b.status === 'loss') byDate[date].losses++;
        else if (b.status === 'push') byDate[date].pushes++;
        else byDate[date].pending++;
        if (b.profit_units != null) byDate[date].profit += b.profit_units;
      }
      return byDate;
    }

    // ── Render Stats ──
    function renderStats() {
      const bets = getBetsForDisplay();
      const unitSize = getUnitSize();

      const wins = bets.filter(b => b.status === 'win').length;
      const losses = bets.filter(b => b.status === 'loss').length;
      const graded = wins + losses;
      const winRate = graded > 0 ? ((wins / graded) * 100).toFixed(1) : '0.0';

      let totalUnits = 0;
      for (const b of bets) {
        if (b.profit_units != null) totalUnits += b.profit_units;
      }
      const totalDollars = totalUnits * unitSize;

      const profitClass = totalUnits > 0 ? 'positive' : totalUnits < 0 ? 'negative' : 'neutral';
      const profitSign = totalUnits >= 0 ? '+' : '';

      const profitDisplay = displayMode === 'units'
        ? `${profitSign}${totalUnits.toFixed(2)}u`
        : `${profitSign}$${totalDollars.toFixed(2)}`;

      document.getElementById('stats-row').innerHTML = `
        <div class="stat-pill">
          <div class="stat-pill-value ${profitClass}">${profitDisplay}</div>
          <div class="stat-pill-label">Profit</div>
        </div>
        <div class="stat-pill">
          <div class="stat-pill-value ${parseFloat(winRate) >= 50 ? 'positive' : parseFloat(winRate) > 0 ? 'negative' : 'neutral'}">${winRate}%</div>
          <div class="stat-pill-label">Win Rate</div>
        </div>
        <div class="stat-pill">
          <div class="stat-pill-value neutral">${bets.length}</div>
          <div class="stat-pill-label">Total Bets</div>
        </div>
        <div class="stat-pill">
          <div class="stat-pill-value positive">${wins}-${losses}</div>
          <div class="stat-pill-label">Record</div>
        </div>
      `;
    }

    // ── Calendar ──
    function navMonth(delta) {
      calViewMonth += delta;
      if (calViewMonth < 0) { calViewMonth = 11; calViewYear--; }
      if (calViewMonth > 11) { calViewMonth = 0; calViewYear++; }
      renderCalendar();
      renderMonthSummary();
    }

    function renderCalendar() {
      const today = getLocalDateStr();
      const betsByDate = getBetsByDate();
      document.getElementById('calendar-title').textContent = `${MONTH_NAMES[calViewMonth]} ${calViewYear}`;

      const firstDay = new Date(calViewYear, calViewMonth, 1).getDay();
      const daysInMonth = new Date(calViewYear, calViewMonth + 1, 0).getDate();
      const daysInPrev = new Date(calViewYear, calViewMonth, 0).getDate();
      const prevM = calViewMonth === 0 ? 11 : calViewMonth - 1;
      const prevY = calViewMonth === 0 ? calViewYear - 1 : calViewYear;
      const nextM = calViewMonth === 11 ? 0 : calViewMonth + 1;
      const nextY = calViewMonth === 11 ? calViewYear + 1 : calViewYear;

      let html = '';

      // Previous month days
      for (let i = firstDay - 1; i >= 0; i--) {
        const d = daysInPrev - i;
        const key = `${prevY}-${String(prevM + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        html += calDayHtml(key, d, today, betsByDate, true);
      }

      // Current month days
      for (let d = 1; d <= daysInMonth; d++) {
        const key = `${calViewYear}-${String(calViewMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        html += calDayHtml(key, d, today, betsByDate, false);
      }

      // Next month days
      const totalCells = firstDay + daysInMonth;
      const remaining = (totalCells % 7 === 0) ? 0 : 7 - (totalCells % 7);
      for (let d = 1; d <= remaining; d++) {
        const key = `${nextY}-${String(nextM + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        html += calDayHtml(key, d, today, betsByDate, true);
      }

      document.getElementById('calendar-grid').innerHTML = html;
      renderMonthSummary();
    }

    function calDayHtml(dateStr, day, today, betsByDate, isOtherMonth) {
      const bets = betsByDate[dateStr];
      const hasBets = !!bets;
      const isToday = dateStr === today;
      const isFuture = dateStr > today;
      const isSelected = dateStr === selectedDate && dateRangeMode === 'single';

      let cls = 'calendar-day';
      if (isOtherMonth) cls += ' other-month';
      if (isToday) cls += ' today';
      if (isFuture && !hasBets) cls += ' future';
      if (hasBets) {
        cls += ' has-bets';
        const { wins, losses, pending } = bets;
        if (pending > 0 && wins === 0 && losses === 0) cls += ' pending-day';
        else if (losses === 0 && wins > 0) cls += ' win-day';
        else if (wins === 0 && losses > 0) cls += ' loss-day';
        else if (wins > 0 || losses > 0) cls += ' mixed-day';
      }
      if (isSelected) cls += ' selected';

      let dot = '';
      if (hasBets) {
        const { wins, losses, pending } = bets;
        if (pending > 0 && wins === 0 && losses === 0) dot = '<span class="calendar-dot pending"></span>';
        else if (losses === 0 && wins > 0) dot = '<span class="calendar-dot win"></span>';
        else if (wins === 0 && losses > 0) dot = '<span class="calendar-dot loss"></span>';
        else if (wins > 0 || losses > 0) dot = '<span class="calendar-dot mixed"></span>';
      }

      const clickable = !isOtherMonth && (!isFuture || hasBets);
      const onclick = clickable ? `onclick="selectCalendarDate('${dateStr}')"` : '';

      return `<div class="${cls}" ${onclick}>${day}${dot}</div>`;
    }

    function renderMonthSummary() {
      const bets = getTrackedBets();
      const unitSize = getUnitSize();
      const monthKey = `${calViewYear}-${String(calViewMonth + 1).padStart(2, '0')}`;

      const monthBets = bets.filter(b => {
        const date = b.date || (b.placed_at ? b.placed_at.slice(0, 10) : null);
        return date && date.startsWith(monthKey);
      });

      let wins = 0, losses = 0, profit = 0;
      for (const b of monthBets) {
        if (b.status === 'win') wins++;
        else if (b.status === 'loss') losses++;
        if (b.profit_units != null) profit += b.profit_units;
      }

      const graded = wins + losses;
      const winRate = graded > 0 ? (wins / graded) * 100 : 0;
      const profitClass = profit > 0 ? 'positive' : profit < 0 ? 'negative' : '';
      const profitSign = profit >= 0 ? '+' : '';

      const profitDisplay = displayMode === 'units'
        ? `${profitSign}${profit.toFixed(2)}u`
        : `${profitSign}$${(profit * unitSize).toFixed(2)}`;

      const monthShort = MONTH_NAMES[calViewMonth].slice(0, 3);

      document.getElementById('month-summary').innerHTML = `
        <div class="month-stat">
          <div class="month-stat-value ${profitClass}">${profitDisplay}</div>
          <div class="month-stat-label">${monthShort} P/L</div>
        </div>
        <div class="win-rate-bar">
          <div class="win-rate-label">Win Rate</div>
          <div class="win-rate-track">
            <div class="win-rate-fill" style="width: ${winRate}%"></div>
          </div>
          <div class="win-rate-value">${winRate.toFixed(1)}%</div>
        </div>
        <div class="month-stat">
          <div class="month-stat-value">${wins}-${losses}</div>
          <div class="month-stat-label">${monthShort} Record</div>
        </div>
      `;
    }

    // ── Filters ──
    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active', 'active-green', 'active-red');
        if (btn.dataset.filter === filter) {
          if (filter === 'win') btn.classList.add('active-green');
          else if (filter === 'loss') btn.classList.add('active-red');
          else btn.classList.add('active');
        }
      });
      renderBets();
    }

    // ── Render Bets ──
    function renderBets() {
      const allBets = getTrackedBets();
      let bets = getBetsForDisplay();
      const unitSize = getUnitSize();

      if (currentFilter !== 'all') {
        bets = bets.filter(b => b.status === currentFilter);
      }

      bets.sort((a, b) => {
        if (a.status === 'pending' && b.status !== 'pending') return -1;
        if (b.status === 'pending' && a.status !== 'pending') return 1;
        return new Date(b.placed_at) - new Date(a.placed_at);
      });

      if (bets.length === 0) {
        document.getElementById('bets-container').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#127919;</div>
            <div class="empty-state-title">No bets to show</div>
            <div class="empty-state-text"><a href="dashboard.html">Go to Dashboard</a> to start tracking bets.</div>
          </div>
        `;
        return;
      }

      const rows = bets.map((b) => {
        const typeClass = b.type === 'prop' ? 'prop' : b.type;
        const typeLabel = b.type === 'prop' ? b.prop_type?.toUpperCase() || 'PROP' : b.type.toUpperCase();
        const pickDesc = b.type === 'prop' ? `${b.player} ${b.pick} ${b.line}` : b.pick;
        const gameStr = b.game || '';
        const oddsStr = b.odds > 0 ? `+${b.odds}` : b.odds;

        let profitStr = '--';
        let profitClass = 'neutral';
        if (b.profit_units != null) {
          if (displayMode === 'units') {
            profitStr = (b.profit_units >= 0 ? '+' : '') + b.profit_units.toFixed(2) + 'u';
          } else {
            const dollars = b.profit_units * unitSize;
            profitStr = (dollars >= 0 ? '+' : '') + '$' + dollars.toFixed(2);
          }
          profitClass = b.profit_units > 0 ? 'positive' : b.profit_units < 0 ? 'negative' : 'neutral';
        }

        const origIdx = allBets.findIndex(x => x.id === b.id);

        return `
          <tr>
            <td>
              <div class="bet-pick">${pickDesc}</div>
              <div class="bet-game">${gameStr}${b.actual ? ' | ' + b.actual : ''}</div>
            </td>
            <td><span class="bet-type ${typeClass}">${typeLabel}</span></td>
            <td class="col-hide-mobile">${oddsStr}</td>
            <td class="col-hide-mobile">${b.units}u</td>
            <td><span class="bet-status ${b.status}">${b.status}</span></td>
            <td><span class="bet-profit ${profitClass}">${profitStr}</span></td>
            <td><button class="bet-delete" onclick="deleteBet(${origIdx})" title="Delete">&#10005;</button></td>
          </tr>
        `;
      }).join('');

      document.getElementById('bets-container').innerHTML = `
        <table class="bets-table">
          <thead>
            <tr>
              <th>Pick</th>
              <th>Type</th>
              <th class="col-hide-mobile">Odds</th>
              <th class="col-hide-mobile">Units</th>
              <th>Status</th>
              <th>P/L</th>
              <th></th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function deleteBet(idx) {
      const bets = getTrackedBets();
      if (idx >= 0 && idx < bets.length) {
        bets.splice(idx, 1);
        saveTrackedBets(bets); // This will trigger cloud sync via debouncedSyncToCloud
        renderStats();
        renderBets();
        renderCalendar();
      }
    }

    // ── Clear Confirm ──
    function showClearConfirm() {
      const bets = getBetsForDisplay();
      if (bets.length === 0) return;

      let dateLabel = 'all';
      if (dateRangeMode === 'today') dateLabel = "today's";
      else if (dateRangeMode === 'week') dateLabel = "this week's";
      else if (dateRangeMode === 'month') dateLabel = "this month's";
      else if (dateRangeMode === 'single' && selectedDate) dateLabel = formatDateLabel(selectedDate);

      document.getElementById('confirm-title').textContent = `Clear ${dateLabel} bets?`;
      document.getElementById('confirm-text').textContent = `This will delete ${bets.length} bet(s).`;
      document.getElementById('confirm-backdrop').classList.add('visible');
    }

    function hideConfirm() {
      document.getElementById('confirm-backdrop').classList.remove('visible');
    }

    async function confirmClearAll() {
      const betsToDelete = dateRangeMode === 'all' ? getTrackedBets() : getBetsForDisplay();
      const idsToDelete = new Set(betsToDelete.map(b => b.id));

      let remaining = [];
      if (dateRangeMode === 'all') {
        saveTrackedBets([], true); // Skip auto-sync
      } else {
        const allBets = getTrackedBets();
        remaining = allBets.filter(b => !idsToDelete.has(b.id));
        saveTrackedBets(remaining, true); // Skip auto-sync
      }

      // Sync remaining bets to Firestore
      if (currentUser) {
        updateSyncStatus('syncing', 'Deleting...');
        try {
          await db.collection('users').doc(currentUser.uid).update({
            trackedBets: remaining,
            lastBetSync: firebase.firestore.FieldValue.serverTimestamp()
          });
          updateSyncStatus('synced', 'Deleted');
        } catch (err) {
          console.error('Failed to sync deletion:', err);
          updateSyncStatus('error', 'Delete failed');
        }
      }

      hideConfirm();
      renderStats();
      renderBets();
      renderCalendar();
    }

    // ── Settings ──
    function saveSettings() {
      const unitSize = parseFloat(document.getElementById('unit-size').value) || 10;
      const settings = getBetSettings();
      settings.unit_size = unitSize;
      saveBetSettings(settings);
      renderStats();
      renderBets();
      renderMonthSummary();

      // Also save to Firestore if logged in
      if (currentUser) {
        db.collection('users').doc(currentUser.uid).update({
          'settings.unitSize': unitSize
        }).catch(err => console.error('Failed to save settings:', err));
      }
    }

    function loadSettings() {
      const settings = getBetSettings();
      document.getElementById('unit-size').value = settings.unit_size || 10;
      displayMode = settings.display_mode || 'units';
      document.getElementById('toggle-units').classList.toggle('active', displayMode === 'units');
      document.getElementById('toggle-dollars').classList.toggle('active', displayMode === 'dollars');
    }

    async function loadCloudSettings() {
      if (!currentUser) return;
      try {
        const doc = await db.collection('users').doc(currentUser.uid).get();
        if (doc.exists) {
          const data = doc.data();
          if (data.settings?.unitSize) {
            const settings = getBetSettings();
            settings.unit_size = data.settings.unitSize;
            saveBetSettings(settings);
            document.getElementById('unit-size').value = data.settings.unitSize;
          }
        }
      } catch (err) {
        console.error('Failed to load cloud settings:', err);
      }
    }

    // ── Auto-Grading ──
    async function loadGameData() {
      try {
        const [nbaResp, nhlResp, resultsResp, nhlResultsResp] = await Promise.all([
          fetch(GAME_DATA_URL + '?t=' + Date.now()),
          fetch(NHL_GAME_DATA_URL + '?t=' + Date.now()),
          fetch(RESULTS_URL + '?t=' + Date.now()),
          fetch(NHL_RESULTS_URL + '?t=' + Date.now())
        ]);

        if (nbaResp.ok) gameProjections = (await nbaResp.json()).games || [];
        if (nhlResp.ok) nhlGameProjections = (await nhlResp.json()).games || [];
        if (resultsResp.ok) resultsData = await resultsResp.json();
        if (nhlResultsResp.ok) nhlResultsData = await nhlResultsResp.json();
      } catch (err) {
        console.error('Failed to load game data:', err);
      }
    }

    function findGameResult(bet) {
      const games = bet.sport === 'NHL' ? nhlGameProjections : gameProjections;
      const gameParts = (bet.game || '').split(' @ ');
      if (gameParts.length !== 2) return null;
      const [away, home] = gameParts;

      const currentGame = games.find(g => g.away_team === away && g.home_team === home);
      if (currentGame && (currentGame.status === 'final' || currentGame.status === 'closed')) {
        if (currentGame.away_score != null && currentGame.home_score != null) {
          return {
            awayScore: currentGame.away_score,
            homeScore: currentGame.home_score,
            spreadResult: currentGame.spread_result,
            totalResult: currentGame.total_result,
            mlResult: currentGame.ml_result
          };
        }
      }

      const results = bet.sport === 'NHL' ? nhlResultsData : resultsData;
      if (!results || !results.days) return null;

      const betDate = bet.date || (bet.placed_at ? bet.placed_at.slice(0, 10) : null);
      if (!betDate) return null;

      const day = results.days.find(d => d.date === betDate);
      if (!day || !day.picks) return null;

      const gamePicks = day.picks.filter(p => p.game === bet.game);
      if (gamePicks.length === 0) return null;

      const pickWithScore = gamePicks.find(p => p.result && p.result.includes('-'));
      if (!pickWithScore) return null;

      const scores = pickWithScore.result.split('-').map(s => parseInt(s.trim()));
      if (scores.length !== 2 || isNaN(scores[0]) || isNaN(scores[1])) return null;

      const spreadPick = gamePicks.find(p => p.type === 'spread');
      const totalPick = gamePicks.find(p => p.type === 'total');
      const mlPick = gamePicks.find(p => p.type === 'ml');

      return {
        awayScore: scores[0],
        homeScore: scores[1],
        spreadResult: spreadPick ? (spreadPick.hit === true ? 'win' : spreadPick.hit === false ? 'loss' : 'push') : null,
        totalResult: totalPick ? (totalPick.hit === true ? 'win' : totalPick.hit === false ? 'loss' : 'push') : null,
        mlResult: mlPick ? (mlPick.hit === true ? 'win' : mlPick.hit === false ? 'loss' : 'push') : null
      };
    }

    function gradeBet(bet, gameResult) {
      if (!gameResult) return null;
      const { awayScore, homeScore } = gameResult;

      if (bet.type === 'spread') {
        if (gameResult.spreadResult) return gameResult.spreadResult;
        const pickMatch = (bet.pick || '').match(/([A-Z]{2,3})\s*([+-]?\d+\.?\d*)/);
        if (!pickMatch) return null;
        const pickTeam = pickMatch[1];
        const pickLine = parseFloat(pickMatch[2]);
        const gameParts = (bet.game || '').split(' @ ');
        const isHome = pickTeam === gameParts[1];
        const actualSpread = homeScore - awayScore;
        const coverMargin = isHome ? actualSpread + pickLine : -actualSpread + pickLine;
        if (coverMargin > 0) return 'win';
        if (coverMargin < 0) return 'loss';
        return 'push';
      }

      if (bet.type === 'total') {
        if (gameResult.totalResult) return gameResult.totalResult;
        const total = awayScore + homeScore;
        const pickMatch = (bet.pick || '').match(/(OVER|UNDER)\s+([\d.]+)/i);
        if (!pickMatch) return null;
        const direction = pickMatch[1].toUpperCase();
        const line = parseFloat(pickMatch[2]);
        if (direction === 'OVER') return total > line ? 'win' : total < line ? 'loss' : 'push';
        return total < line ? 'win' : total > line ? 'loss' : 'push';
      }

      if (bet.type === 'ml') {
        if (gameResult.mlResult) return gameResult.mlResult;
        const gameParts = (bet.game || '').split(' @ ');
        const winner = homeScore > awayScore ? gameParts[1] : gameParts[0];
        return bet.pick === winner ? 'win' : 'loss';
      }

      return null;
    }

    async function autoGradeBets() {
      const statusEl = document.getElementById('grading-status');
      statusEl.textContent = 'Checking...';
      statusEl.classList.add('grading');

      await loadGameData();

      const bets = getTrackedBets();
      let changed = false;
      let gradedCount = 0;

      for (const bet of bets) {
        if (bet.status !== 'pending') continue;
        if (bet.type === 'prop') continue;

        const gameResult = findGameResult(bet);
        if (!gameResult) continue;

        const result = gradeBet(bet, gameResult);
        if (!result) continue;

        bet.status = result;
        bet.actual = `${gameResult.awayScore}-${gameResult.homeScore}`;

        if (result === 'win') bet.profit_units = calcProfit(bet.odds, bet.units);
        else if (result === 'loss') bet.profit_units = -bet.units;
        else bet.profit_units = 0;

        changed = true;
        gradedCount++;
      }

      if (changed) {
        saveTrackedBets(bets); // This triggers cloud sync
        renderStats();
        renderBets();
        renderCalendar();
      }

      if (gradedCount > 0) {
        statusEl.textContent = `Graded ${gradedCount}`;
        setTimeout(() => { statusEl.textContent = ''; }, 3000);
      } else {
        statusEl.textContent = '';
      }
      statusEl.classList.remove('grading');
    }

    // ── Manual Sync Button ──
    async function manualSync() {
      if (!currentUser) {
        alert('Please log in to sync your bets');
        return;
      }
      await syncBetsToCloud();
      await syncBetsFromCloud();
      renderStats();
      renderBets();
      renderCalendar();
    }

    // ── Initialize ──
    async function init() {
      loadSettings();
      selectedDate = getLocalDateStr();
      dateRangeMode = 'today';
      updateBetsTitle();
      renderStats();
      renderCalendar();
      renderBets();

      // Set up auth state listener
      auth.onAuthStateChanged(async (user) => {
        currentUser = user;

        if (user) {
          console.log('User logged in:', user.email);
          showLoginPrompt(false);

          // Sync bets from cloud
          await syncBetsFromCloud();
          await loadCloudSettings();

          // Re-render with synced data
          renderStats();
          renderBets();
          renderCalendar();
        } else {
          console.log('User not logged in');
          showLoginPrompt(true);
          updateSyncStatus('offline', 'Local only');
        }
      });

      await autoGradeBets();

      // Auto-grade every 5 minutes
      setInterval(autoGradeBets, 5 * 60 * 1000);

      // Sync to cloud every 5 minutes if logged in
      setInterval(() => {
        if (currentUser) syncBetsToCloud();
      }, 5 * 60 * 1000);
    }

    // Listen for bets from other tabs/windows
    window.addEventListener('storage', (e) => {
      if (e.key === LS_BETS) {
        renderStats();
        renderBets();
        renderCalendar();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') hideConfirm();
    });

    // Sync before page unload
    window.addEventListener('beforeunload', () => {
      if (currentUser && !isSyncing) {
        // Use sendBeacon for reliable sync on page close
        const bets = getTrackedBets();
        // Note: sendBeacon doesn't work with Firestore, so we'll rely on debounced sync
      }
    });

    init();
  </script>
</body>
</html>
