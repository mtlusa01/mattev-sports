<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edge Factor Elite | Profile</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none !important; margin: 0 !important; display: none !important; }
    input[type="number"] { -moz-appearance: textfield !important; appearance: textfield !important; }
    :root {
      --bg-primary: #09090b; --bg-secondary: #18181b; --bg-tertiary: #27272a;
      --border: rgba(255,255,255,0.08); --border-light: rgba(255,255,255,0.12);
      --text-primary: #fafafa; --text-secondary: #a1a1aa; --text-muted: #71717a;
      --brand: #dc2626; --brand-light: #ef4444;
      --accent: #dc2626; --accent-light: #34d399;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; -webkit-font-smoothing: antialiased; }

    .top-nav { background: #0f0f0f; border-bottom: 1px solid #2a2a2a; position: fixed; top: 0; left: 0; right: 0; height: 60px; z-index: 100; display: flex; align-items: center; }
    .top-nav-inner { position: relative; max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; width: 100%; height: 100%; display: flex; align-items: center; justify-content: space-between; }
    .nav-brand { position: relative; z-index: 2; }
    .sports-tabs { display: flex; align-items: center; gap: 4px; background: var(--bg-tertiary); border-radius: 10px; padding: 4px; position: absolute; left: 50%; transform: translateX(-50%); z-index: 1; }
    .sport-tab { padding: 6px 18px; border-radius: 8px; border: none; background: transparent; color: var(--text-muted); font-size: 13px; font-weight: 600; font-family: inherit; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
    .sport-tab:hover { color: var(--text-secondary); }
    .sport-tab.active { background: var(--brand); color: #fff; box-shadow: 0 2px 8px rgba(220,38,38,0.3); }
    .soon-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; padding: 1px 5px; border-radius: 4px; background: rgba(255,255,255,0.1); color: var(--text-muted); }
    .sport-tab.active .soon-badge { display: none; }
    .nav-right { display: flex; align-items: center; gap: 1.5rem; position: relative; z-index: 2; }
    .nav-link { color: #a0a0a0; text-decoration: none; font-size: 0.9rem; transition: color 0.2s; font-weight: 500; }
    .nav-link:hover { color: #fff; }
    .mobile-menu-btn { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

    /* ── Mobile Drawer ── */
    .mobile-nav-backdrop {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 9998;
    }
    .mobile-nav-backdrop.open { display: block; }
    .mobile-nav-drawer {
      position: fixed; top: 60px; left: 0; right: 0;
      background: #1a1a24; z-index: 9999;
      overflow: hidden; max-height: 0; transition: max-height 0.3s ease;
    }
    .mobile-nav-drawer:not(.open) { pointer-events: none; border: none !important; box-shadow: none !important; }
    .mobile-nav-drawer.open { max-height: 500px; border-bottom: 2px solid #2a2a3a; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
    .mobile-drawer-links a {
      display: flex; align-items: center; gap: 12px; padding: 14px 24px;
      color: #ffffff; text-decoration: none; font-size: 16px; font-weight: 500;
      border-bottom: 1px solid #2a2a3a; transition: all 0.15s;
    }
    .mobile-drawer-links a:hover, .mobile-drawer-links a.active {
      color: #dc2626; background: rgba(220,38,38,0.08);
    }
    .mobile-drawer-links a .menu-icon { font-size: 18px; width: 24px; text-align: center; flex-shrink: 0; }
    .mobile-drawer-auth { padding: 12px 24px 16px; }
    .mobile-drawer-login-btn {
      display: block; width: 100%; padding: 12px; background: #dc2626; color: white;
      border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;
      text-align: center; text-decoration: none; transition: background 0.15s;
    }
    .mobile-drawer-login-btn:hover { background: #b91c1c; }

    /* Auth nav styles */
    .user-menu { position: relative; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--brand); color: white; border: none; font-size: 0.9rem; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
    .user-avatar:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(220,38,38,0.3); }
    .user-dropdown { display: none; position: absolute; top: calc(100% + 0.5rem); right: 0; background: #1a1a24; border: 1px solid #2a2a3a; border-radius: 8px; min-width: 240px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); z-index: 1001; overflow: hidden; }
    .user-dropdown.active { display: block; }
    .dropdown-header { padding: 1rem; display: flex; flex-direction: column; gap: 0.2rem; }
    .user-name { font-weight: 600; color: #f0f0f0; font-size: 0.95rem; }
    .user-email { font-size: 0.75rem; color: #6b7280; }
    .user-role { display: inline-block; font-size: 0.6rem; color: var(--brand); font-weight: 700; text-transform: uppercase; background: rgba(220,38,38,0.1); padding: 0.15rem 0.4rem; border-radius: 4px; margin-top: 0.35rem; width: fit-content; }
    .dropdown-divider { border-top: 1px solid #2a2a3a; }
    .dropdown-item { display: block; padding: 0.75rem 1rem; color: #9ca3af; text-decoration: none; font-size: 0.85rem; transition: all 0.15s; }
    .dropdown-item:hover { background: #252532; color: #f0f0f0; }
    .login-btn-pill { background: var(--brand); color: white; padding: 0.4rem 1rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }

    /* Profile Content */
    main { max-width: 640px; margin: 0 auto; padding: 90px 24px 60px; }
    .loading-state { text-align: center; padding: 60px 0; color: var(--text-muted); }

    .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 32px; }
    .profile-avatar { width: 64px; height: 64px; border-radius: 50%; background: var(--brand); color: white; font-size: 28px; font-weight: 800; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .profile-info h1 { font-size: 22px; font-weight: 700; margin-bottom: 2px; }
    .profile-meta { font-size: 13px; color: var(--text-muted); display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .role-badge { font-size: 10px; font-weight: 700; text-transform: uppercase; padding: 2px 8px; border-radius: 4px; background: rgba(220,38,38,0.15); color: var(--brand-light); }

    .settings-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 16px; }
    .settings-card h2 { font-size: 16px; font-weight: 700; margin-bottom: 20px; }

    .field-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .field-row:last-child { margin-bottom: 0; }
    .field-label { font-size: 13px; color: var(--text-secondary); }
    .field-value { font-size: 13px; color: var(--text-muted); }
    .field-hint { font-size: 11px; color: var(--text-muted); margin-top: 2px; max-width: 280px; line-height: 1.4; }

    .form-input { width: 100%; padding: 10px 14px; background: var(--bg-primary); border: 1px solid #2a2a3a; border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit; outline: none; transition: border-color 0.2s; }
    .form-input:focus { border-color: var(--brand); }
    .form-input.short { width: 120px; text-align: right; }
    .form-input:read-only { opacity: 0.5; cursor: not-allowed; }

    .toggle-group { display: flex; gap: 4px; background: var(--bg-primary); border-radius: 8px; padding: 3px; }
    .toggle-opt { padding: 6px 14px; border-radius: 6px; border: none; background: transparent; color: var(--text-muted); font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .toggle-opt.active { background: var(--brand); color: white; }

    .range-row { margin-bottom: 16px; }
    .range-row:last-child { margin-bottom: 0; }
    .range-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .range-label { font-size: 13px; color: var(--text-secondary); }
    .range-value { font-size: 13px; font-weight: 600; color: var(--text-primary); min-width: 40px; text-align: right; }
    input[type="range"] { width: 100%; -webkit-appearance: none; height: 4px; border-radius: 2px; background: var(--bg-tertiary); outline: none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--brand); cursor: pointer; border: 2px solid var(--bg-primary); }

    .btn-save { display: inline-flex; align-items: center; gap: 6px; padding: 10px 24px; background: linear-gradient(135deg, #dc2626, #991b1b); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .btn-save:hover { background: linear-gradient(135deg, #ef4444, #dc2626); transform: translateY(-1px); }
    .btn-save:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .btn-secondary { padding: 8px 16px; background: transparent; border: 1px solid #2a2a3a; border-radius: 8px; color: var(--text-secondary); font-size: 13px; font-weight: 500; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .btn-secondary:hover { border-color: var(--text-muted); color: var(--text-primary); }
    .btn-danger { padding: 8px 16px; background: transparent; border: 1px solid rgba(220,38,38,0.3); border-radius: 8px; color: var(--brand-light); font-size: 13px; font-weight: 500; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .btn-danger:hover { background: rgba(220,38,38,0.1); }

    .save-bar { display: flex; align-items: center; gap: 12px; margin-top: 24px; }
    .save-msg { font-size: 13px; color: var(--accent-light); display: none; }
    .save-msg.visible { display: block; }

    .confirm-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center; }
    .confirm-box { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; }
    .confirm-box h3 { font-size: 16px; margin-bottom: 8px; }
    .confirm-box p { font-size: 13px; color: var(--text-secondary); margin-bottom: 20px; }
    .confirm-actions { display: flex; gap: 8px; justify-content: flex-end; }

    /* Phase 1: Investment Profile styles */
    .form-select { width: 100%; padding: 10px 14px; background: var(--bg-primary); border: 1px solid #2a2a3a; border-radius: 8px; color: var(--text-primary); font-size: 13px; font-family: inherit; outline: none; transition: border-color 0.2s; cursor: pointer; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2371717a' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }
    .form-select:focus { border-color: var(--brand); }
    .form-select option { background: var(--bg-primary); color: var(--text-primary); }
    .section-desc { font-size: 12px; color: var(--text-muted); margin-top: -12px; margin-bottom: 16px; line-height: 1.5; }
    .kelly-info { margin-top: 12px; padding: 12px 16px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6; }
    .kelly-info p { margin-bottom: 6px; }
    .kelly-info strong { color: var(--text-secondary); }

    @media (max-width: 768px) {
      .nav-right { display: none; }
      .sports-tabs { display: none; }
      .mobile-menu-btn { display: block; }
      .top-nav-inner { padding: 0 1rem; }
      .profile-header { flex-direction: column; text-align: center; }
      .field-row { flex-direction: column; align-items: flex-start; gap: 6px; }
      .form-input.short { width: 100%; text-align: left; }
    }
  </style>
</head>
<body>

  <header class="top-nav">
    <div class="top-nav-inner">
      <div class="nav-brand">
        <a href="index.html" style="display:flex;align-items:center;text-decoration:none;">
          <span style="font-size:1.4rem;font-weight:800;color:#f0f0f0;letter-spacing:-0.02em;white-space:nowrap;">Edge Factor <span style="color:#dc2626;">Elite</span></span>
        </a>
      </div>
      <div class="sports-tabs">
        <button class="sport-tab active" data-sport="nba">NBA</button>
        <button class="sport-tab" data-sport="nhl">NHL <span class="soon-badge">Soon</span></button>
        <button class="sport-tab" data-sport="mlb">MLB <span class="soon-badge">Soon</span></button>
      </div>
      <div class="nav-right">
        <a href="dashboard.html" class="nav-link">Projections</a>
        <a href="results.html" class="nav-link">Results</a>
        <a href="mybets.html" class="nav-link">My Bets</a>
        <a href="about.html" class="nav-link">About</a>
      </div>
      <button class="mobile-menu-btn" onclick="toggleMobileNav()" aria-label="Menu">&#9776;</button>
    </div>
  </header>

  <div class="mobile-nav-backdrop" id="mobile-nav-backdrop" onclick="closeMobileNav()"></div>
  <div class="mobile-nav-drawer" id="mobile-nav-drawer">
    <div class="mobile-drawer-links">
      <a href="dashboard.html"><span class="menu-icon">&#128200;</span> Projections</a>
      <a href="results.html"><span class="menu-icon">&#128202;</span> Results</a>
      <a href="mybets.html"><span class="menu-icon">&#127919;</span> My Bets</a>
      <a href="about.html"><span class="menu-icon">&#8505;&#65039;</span> About</a>
    </div>
    <div class="mobile-drawer-auth" id="mobile-drawer-auth">
      <a href="login.html" class="mobile-drawer-login-btn">&#128100; Log In / Sign Up</a>
    </div>
  </div>

  <main>
    <div class="loading-state" id="loading-state">Loading profile...</div>

    <div id="profile-content" style="display:none;">
      <!-- Profile Header -->
      <div class="profile-header">
        <div class="profile-avatar" id="profile-avatar">?</div>
        <div class="profile-info">
          <h1 id="profile-name">--</h1>
          <div class="profile-meta">
            <span id="profile-email">--</span>
            <span class="role-badge" id="profile-role">Free</span>
            <span id="profile-since">--</span>
          </div>
        </div>
      </div>

      <!-- Profile Card -->
      <div class="settings-card">
        <h2>Profile</h2>
        <div class="field-row">
          <span class="field-label">Display Name</span>
          <input type="text" class="form-input short" id="set-name" style="width:200px;text-align:left;">
        </div>
        <div class="field-row">
          <span class="field-label">Email</span>
          <span class="field-value" id="set-email">--</span>
        </div>
      </div>

      <!-- Display Preferences -->
      <div class="settings-card">
        <h2>Display Preferences</h2>
        <div class="field-row">
          <span class="field-label">Default View</span>
          <div class="toggle-group" id="toggle-view">
            <button class="toggle-opt active" data-val="games">Game Projections</button>
            <button class="toggle-opt" data-val="props">Player Props</button>
          </div>
        </div>
        <div class="field-row">
          <span class="field-label">Odds Format</span>
          <div class="toggle-group" id="toggle-odds">
            <button class="toggle-opt active" data-val="american">American</button>
            <button class="toggle-opt" data-val="decimal">Decimal</button>
          </div>
        </div>
      </div>

      <!-- Bet Settings -->
      <div class="settings-card">
        <h2>Bet Settings</h2>
        <div class="field-row">
          <span class="field-label">Default Bet Size</span>
          <input type="text" inputmode="numeric" class="form-input short" id="set-betsize" value="10">
        </div>
        <div class="field-row">
          <span class="field-label">Unit Size</span>
          <input type="text" inputmode="numeric" class="form-input short" id="set-unitsize" value="10">
        </div>
        <div class="field-row">
          <span class="field-label">Bankroll (optional)</span>
          <input type="text" inputmode="numeric" class="form-input short" id="set-bankroll" placeholder="--">
        </div>
      </div>

      <!-- Bet Tracking (localStorage) -->
      <div class="settings-card">
        <h2>Bet Tracking</h2>
        <div class="field-row">
          <div>
            <span class="field-label">Unit Size</span>
            <div class="field-hint">How much is 1 unit worth to you? Used to calculate dollar amounts on My Bets.</div>
          </div>
          <div style="display:flex;align-items:center;gap:4px;">
            <span style="color:var(--text-muted);font-size:14px;">$</span>
            <input type="text" inputmode="numeric" class="form-input short" id="set-tracking-unitsize" value="10" onchange="saveBetTrackingSettings()" style="width:80px;">
          </div>
        </div>
        <div class="field-row">
          <div>
            <span class="field-label">Display Mode</span>
            <div class="field-hint">Choose how profits are shown on My Bets.</div>
          </div>
          <div class="toggle-group" id="toggle-display-mode">
            <button class="toggle-opt active" data-val="units" onclick="saveBetTrackingSettings()">Units</button>
            <button class="toggle-opt" data-val="dollars" onclick="saveBetTrackingSettings()">Dollars</button>
          </div>
        </div>
      </div>

      <!-- Notification Prefs -->
      <div class="settings-card">
        <h2>Alert Thresholds</h2>
        <div class="range-row">
          <div class="range-header">
            <span class="range-label">Min Confidence</span>
            <span class="range-value" id="conf-val">55%</span>
          </div>
          <input type="range" id="set-conf" min="50" max="70" value="55" oninput="document.getElementById('conf-val').textContent=this.value+'%'">
        </div>
        <div class="range-row">
          <div class="range-header">
            <span class="range-label">Min EV</span>
            <span class="range-value" id="ev-val">3%</span>
          </div>
          <input type="range" id="set-ev" min="0" max="10" value="3" step="0.5" oninput="document.getElementById('ev-val').textContent=this.value+'%'">
        </div>
      </div>

      <!-- Investment Strategy -->
      <div class="settings-card">
        <h2>Investment Strategy</h2>
        <div class="field-row">
          <div>
            <span class="field-label">Betting Goal</span>
            <div class="field-hint">What are you trying to achieve?</div>
          </div>
          <select class="form-select" id="set-goal" style="width:220px;">
            <option value="income">Monthly Income</option>
            <option value="growth">Bankroll Growth</option>
            <option value="entertainment">Entertainment</option>
            <option value="professional">Professional</option>
          </select>
        </div>
        <div class="field-row">
          <div>
            <span class="field-label">Monthly Target</span>
            <div class="field-hint">Your profit goal per month.</div>
          </div>
          <div style="display:flex;align-items:center;gap:4px;">
            <span style="color:var(--text-muted);font-size:14px;">$</span>
            <input type="text" inputmode="numeric" class="form-input short" id="set-monthly-target" value="500" style="width:90px;">
          </div>
        </div>
        <div class="field-row">
          <span class="field-label">Risk Tolerance</span>
          <div class="toggle-group" id="toggle-risk">
            <button class="toggle-opt" data-val="conservative">Conservative</button>
            <button class="toggle-opt active" data-val="moderate">Moderate</button>
            <button class="toggle-opt" data-val="aggressive">Aggressive</button>
            <button class="toggle-opt" data-val="custom">Custom</button>
          </div>
        </div>
        <div class="range-row">
          <div class="range-header">
            <span class="range-label">Max Drawdown</span>
            <span class="range-value" id="drawdown-val">15%</span>
          </div>
          <input type="range" id="set-drawdown" min="10" max="50" step="5" value="15" oninput="document.getElementById('drawdown-val').textContent=this.value+'%'">
        </div>
        <div class="range-row">
          <div class="range-header">
            <span class="range-label">Max Bet Size (% of bankroll)</span>
            <span class="range-value" id="maxbet-val">5%</span>
          </div>
          <input type="range" id="set-maxbet" min="1" max="10" step="0.5" value="5" oninput="document.getElementById('maxbet-val').textContent=this.value+'%'">
        </div>
      </div>

      <!-- Bet Sizing Strategy -->
      <div class="settings-card">
        <h2>Bet Sizing Strategy</h2>
        <div class="field-row">
          <div>
            <span class="field-label">Kelly Criterion</span>
            <div class="field-hint">Optimal bet sizing based on edge.</div>
          </div>
          <div class="toggle-group" id="toggle-kelly">
            <button class="toggle-opt" data-val="off">Off</button>
            <button class="toggle-opt" data-val="quarter">Quarter</button>
            <button class="toggle-opt active" data-val="half">Half</button>
            <button class="toggle-opt" data-val="full">Full</button>
          </div>
        </div>
        <div class="kelly-info">
          <p><strong>Off:</strong> Fixed unit sizing &middot; <strong>Quarter:</strong> Conservative Kelly &middot; <strong>Half:</strong> Balanced (recommended) &middot; <strong>Full:</strong> Maximum growth, high volatility</p>
        </div>
      </div>

      <!-- Sports Preferences -->
      <div class="settings-card">
        <h2>Sports Preferences</h2>
        <p class="section-desc">Weight how much you want to see picks from each sport (0 = hide, 10 = prioritize).</p>
        <div class="range-row">
          <div class="range-header">
            <span class="range-label">NBA</span>
            <span class="range-value" id="nba-wt-val">7</span>
          </div>
          <input type="range" id="set-nba-wt" min="0" max="10" value="7" oninput="document.getElementById('nba-wt-val').textContent=this.value">
        </div>
        <div class="range-row">
          <div class="range-header">
            <span class="range-label">NCAAB</span>
            <span class="range-value" id="ncaab-wt-val">5</span>
          </div>
          <input type="range" id="set-ncaab-wt" min="0" max="10" value="5" oninput="document.getElementById('ncaab-wt-val').textContent=this.value">
        </div>
        <div class="range-row">
          <div class="range-header">
            <span class="range-label">NHL</span>
            <span class="range-value" id="nhl-wt-val">3</span>
          </div>
          <input type="range" id="set-nhl-wt" min="0" max="10" value="3" oninput="document.getElementById('nhl-wt-val').textContent=this.value">
        </div>
      </div>

      <!-- Account -->
      <div class="settings-card">
        <h2>Account</h2>
        <div class="field-row">
          <span class="field-label">Password</span>
          <button class="btn-secondary" onclick="sendPasswordReset()">Send Reset Email</button>
        </div>
        <div class="field-row">
          <span class="field-label">Delete Account</span>
          <button class="btn-danger" onclick="showDeleteConfirm()">Delete Account</button>
        </div>
      </div>

      <!-- Save -->
      <div class="save-bar">
        <button class="btn-save" id="save-btn" onclick="saveAll()">Save All Settings</button>
        <span class="save-msg" id="save-msg">Settings saved.</span>
      </div>
    </div>
  </main>

  <!-- Delete Confirmation -->
  <div class="confirm-modal" id="delete-modal" style="display:none;" onclick="if(event.target===this)this.style.display='none'">
    <div class="confirm-box">
      <h3>Delete Account</h3>
      <p>This will permanently delete your account and all settings. This cannot be undone.</p>
      <div class="confirm-actions">
        <button class="btn-secondary" onclick="document.getElementById('delete-modal').style.display='none'">Cancel</button>
        <button class="btn-danger" onclick="deleteAccount()">Delete Forever</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="auth.js"></script>
  <script>
    let profileSettings = {};

    // Require login
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      const profile = await getUserProfile(user.uid);
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('profile-content').style.display = 'block';
      populateProfile(user, profile);
    });

    function populateProfile(user, profile) {
      const name = user.displayName || user.email.split('@')[0];
      const initial = name.charAt(0).toUpperCase();
      document.getElementById('profile-avatar').textContent = initial;
      document.getElementById('profile-name').textContent = name;
      document.getElementById('profile-email').textContent = user.email;
      document.getElementById('set-email').textContent = user.email;
      document.getElementById('set-name').value = name;

      const role = profile?.role || 'free';
      document.getElementById('profile-role').textContent = role === 'admin' ? 'Admin' : 'Free';

      if (profile?.createdAt) {
        const d = profile.createdAt.toDate ? profile.createdAt.toDate() : new Date(profile.createdAt);
        document.getElementById('profile-since').textContent = 'Member since ' + d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      }

      const s = profile?.settings || {};
      profileSettings = { ...s };

      // Populate toggles
      setToggle('toggle-view', s.defaultView || 'games');
      setToggle('toggle-odds', s.oddsFormat || 'american');

      // Populate inputs
      document.getElementById('set-betsize').value = s.betSize || 10;
      document.getElementById('set-unitsize').value = s.unitSize || 10;
      document.getElementById('set-bankroll').value = s.bankroll || '';

      // Populate ranges
      const conf = s.minConfidence || 55;
      const ev = s.minEV || 3;
      document.getElementById('set-conf').value = conf;
      document.getElementById('conf-val').textContent = conf + '%';
      document.getElementById('set-ev').value = ev;
      document.getElementById('ev-val').textContent = ev + '%';

      // Phase 1: Investment Strategy
      document.getElementById('set-goal').value = s.goalType || 'growth';
      document.getElementById('set-monthly-target').value = s.monthlyTarget || 500;
      setToggle('toggle-risk', s.riskTolerance || 'moderate');
      const dd = s.maxDrawdown || 15;
      document.getElementById('set-drawdown').value = dd;
      document.getElementById('drawdown-val').textContent = dd + '%';
      const mb = s.maxBetPct || 5;
      document.getElementById('set-maxbet').value = mb;
      document.getElementById('maxbet-val').textContent = mb + '%';

      // Phase 1: Kelly Criterion
      setToggle('toggle-kelly', s.kellyFraction || 'half');

      // Phase 1: Sports Weighting
      const sw = s.sportsWeighting || { nba: 7, ncaab: 5, nhl: 3 };
      document.getElementById('set-nba-wt').value = sw.nba ?? 7;
      document.getElementById('nba-wt-val').textContent = sw.nba ?? 7;
      document.getElementById('set-ncaab-wt').value = sw.ncaab ?? 5;
      document.getElementById('ncaab-wt-val').textContent = sw.ncaab ?? 5;
      document.getElementById('set-nhl-wt').value = sw.nhl ?? 3;
      document.getElementById('nhl-wt-val').textContent = sw.nhl ?? 3;
    }

    function setToggle(groupId, val) {
      document.querySelectorAll('#' + groupId + ' .toggle-opt').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.val === val);
      });
    }

    // Toggle handlers
    document.querySelectorAll('.toggle-group').forEach(group => {
      group.querySelectorAll('.toggle-opt').forEach(btn => {
        btn.addEventListener('click', () => {
          group.querySelectorAll('.toggle-opt').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });
    });

    // Risk tolerance presets — auto-adjust sliders when toggled
    const RISK_PRESETS = {
      conservative: { drawdown: 10, maxBet: 3,   kelly: 'quarter' },
      moderate:     { drawdown: 15, maxBet: 5,   kelly: 'half' },
      aggressive:   { drawdown: 25, maxBet: 8,   kelly: 'full' },
    };
    document.querySelectorAll('#toggle-risk .toggle-opt').forEach(btn => {
      btn.addEventListener('click', () => {
        const preset = RISK_PRESETS[btn.dataset.val];
        if (!preset) return;
        document.getElementById('set-drawdown').value = preset.drawdown;
        document.getElementById('drawdown-val').textContent = preset.drawdown + '%';
        document.getElementById('set-maxbet').value = preset.maxBet;
        document.getElementById('maxbet-val').textContent = preset.maxBet + '%';
        setToggle('toggle-kelly', preset.kelly);
      });
    });

    // Auto-detect Custom when sliders are manually adjusted
    function checkRiskPreset() {
      const dd = parseInt(document.getElementById('set-drawdown').value);
      const mb = parseFloat(document.getElementById('set-maxbet').value);
      for (const [key, p] of Object.entries(RISK_PRESETS)) {
        if (p.drawdown === dd && p.maxBet === mb) { setToggle('toggle-risk', key); return; }
      }
      setToggle('toggle-risk', 'custom');
    }
    document.getElementById('set-drawdown').addEventListener('input', checkRiskPreset);
    document.getElementById('set-maxbet').addEventListener('input', checkRiskPreset);

    function getToggleVal(groupId) {
      const active = document.querySelector('#' + groupId + ' .toggle-opt.active');
      return active ? active.dataset.val : null;
    }

    async function saveAll() {
      const btn = document.getElementById('save-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      const newName = document.getElementById('set-name').value.trim();
      const settings = {
        defaultView: getToggleVal('toggle-view'),
        oddsFormat: getToggleVal('toggle-odds'),
        betSize: parseInt(document.getElementById('set-betsize').value) || 10,
        unitSize: parseInt(document.getElementById('set-unitsize').value) || 10,
        bankroll: parseInt(document.getElementById('set-bankroll').value) || null,
        minConfidence: parseInt(document.getElementById('set-conf').value) || 55,
        minEV: parseFloat(document.getElementById('set-ev').value) || 3,
        darkMode: true,
        notifications: false,
        showEV: true,
        showHitRate: true,
        defaultSport: 'nba',
        goalType: document.getElementById('set-goal').value || 'growth',
        monthlyTarget: parseInt(document.getElementById('set-monthly-target').value) || 500,
        riskTolerance: getToggleVal('toggle-risk') || 'moderate',
        maxDrawdown: parseInt(document.getElementById('set-drawdown').value) || 15,
        maxBetPct: parseFloat(document.getElementById('set-maxbet').value) || 5,
        kellyFraction: getToggleVal('toggle-kelly') || 'half',
        sportsWeighting: {
          nba: parseInt(document.getElementById('set-nba-wt').value) ?? 7,
          ncaab: parseInt(document.getElementById('set-ncaab-wt').value) ?? 5,
          nhl: parseInt(document.getElementById('set-nhl-wt').value) ?? 3,
        },
      };

      await updateUserProfile({ displayName: newName });
      await saveUserSettings(settings);

      // Sync Firestore unitSize to localStorage bet tracking settings
      saveBetTrackingSettings();

      btn.disabled = false;
      btn.textContent = 'Save All Settings';
      const msg = document.getElementById('save-msg');
      msg.classList.add('visible');
      setTimeout(() => msg.classList.remove('visible'), 3000);

      // Update header
      document.getElementById('profile-name').textContent = newName;
      document.getElementById('profile-avatar').textContent = newName.charAt(0).toUpperCase();
    }

    async function sendPasswordReset() {
      const result = await resetPassword(currentUser.email);
      if (result.success) {
        alert('Password reset email sent to ' + currentUser.email);
      } else {
        alert(result.error);
      }
    }

    function showDeleteConfirm() {
      document.getElementById('delete-modal').style.display = 'flex';
    }

    async function deleteAccount() {
      try {
        await db.collection('users').doc(currentUser.uid).delete();
        await currentUser.delete();
        window.location.href = 'index.html';
      } catch (error) {
        if (error.code === 'auth/requires-recent-login') {
          alert('Please sign out and sign back in, then try again.');
        } else {
          alert('Error: ' + error.message);
        }
        document.getElementById('delete-modal').style.display = 'none';
      }
    }

    // ── Bet Tracking (localStorage) ──
    const LS_SETTINGS = 'efe_user_settings';
    function getBetTrackingSettings() {
      try { return JSON.parse(localStorage.getItem(LS_SETTINGS)) || {}; }
      catch { return {}; }
    }

    function saveBetTrackingSettings() {
      const unitSize = Math.max(1, parseInt(document.getElementById('set-tracking-unitsize').value) || 10);
      const displayMode = getToggleVal('toggle-display-mode') || 'units';
      const s = getBetTrackingSettings();
      s.unit_size = unitSize;
      s.display_mode = displayMode;
      localStorage.setItem(LS_SETTINGS, JSON.stringify(s));
    }

    function loadBetTrackingSettings() {
      const s = getBetTrackingSettings();
      document.getElementById('set-tracking-unitsize').value = s.unit_size || 10;
      setToggle('toggle-display-mode', s.display_mode || 'units');
    }

    // Load on page init
    loadBetTrackingSettings();

    function toggleMobileNav() {
      document.getElementById('mobile-nav-drawer').classList.toggle('open');
      document.getElementById('mobile-nav-backdrop').classList.toggle('open');
    }
    function closeMobileNav() {
      document.getElementById('mobile-nav-drawer').classList.remove('open');
      document.getElementById('mobile-nav-backdrop').classList.remove('open');
    }
  </script>
</body>
</html>
