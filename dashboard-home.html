<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Edge Factor Elite</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #111118;
      --bg-tertiary: #1a1a24;
      --bg-elevated: rgba(37, 37, 50, 0.5);
      --border: rgba(255, 255, 255, 0.08);
      --border-light: rgba(255, 255, 255, 0.12);
      --text-primary: #f0f0f0;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --brand: #dc2626;
      --brand-light: #ef4444;
      --brand-glow: rgba(220, 38, 38, 0.15);
      --accent: #10b981;
      --accent-light: #34d399;
      --accent-glow: rgba(16, 185, 129, 0.15);
      --red: #ef4444;
      --red-light: #f87171;
      --yellow: #f59e0b;
      --blue: #3b82f6;
      --purple: #8b5cf6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    .page-gradient {
      position: fixed; top: 0; left: 0; right: 0; height: 60vh;
      background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(220, 38, 38, 0.08), transparent);
      pointer-events: none; z-index: 0;
    }

    /* ── Skeleton Loading ── */
    @keyframes shimmer {
      0% { background-position: -400px 0; }
      100% { background-position: 400px 0; }
    }
    .skeleton {
      background: linear-gradient(90deg, var(--bg-tertiary) 25%, rgba(255,255,255,0.04) 50%, var(--bg-tertiary) 75%);
      background-size: 800px 100%;
      animation: shimmer 1.8s ease-in-out infinite;
      border-radius: 6px;
    }
    .skeleton-text { height: 14px; width: 60%; margin: 6px 0; }
    .skeleton-lg { height: 28px; width: 40%; margin: 8px 0; }
    .skeleton-bar { height: 6px; width: 100%; margin-top: 10px; }

    /* ── Entrance Animations ── */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-in {
      opacity: 0;
      animation: fadeUp 0.4s ease-out forwards;
    }
    .animate-in:nth-child(1) { animation-delay: 0.05s; }
    .animate-in:nth-child(2) { animation-delay: 0.1s; }
    .animate-in:nth-child(3) { animation-delay: 0.15s; }
    .animate-in:nth-child(4) { animation-delay: 0.2s; }
    .animate-in:nth-child(5) { animation-delay: 0.25s; }

    /* ── Navigation ── */
    .top-nav {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      background: rgba(10, 10, 15, 0.95); backdrop-filter: blur(24px) saturate(1.2);
      border-bottom: 1px solid var(--border);
    }
    .top-nav-inner {
      max-width: 1200px; margin: 0 auto; padding: 0 20px;
      display: flex; align-items: center; justify-content: space-between; height: 60px;
    }
    .nav-brand a { display: flex; align-items: center; text-decoration: none; }
    .nav-brand span { font-size: 1.4rem; font-weight: 800; color: #f0f0f0; letter-spacing: -0.02em; white-space: nowrap; }
    .nav-links { display: flex; align-items: center; gap: 2px; }
    .nav-link {
      color: var(--text-secondary); text-decoration: none; font-size: 13px; font-weight: 500;
      padding: 7px 14px; border-radius: 8px; transition: all 0.2s; position: relative;
    }
    .nav-link:hover { color: var(--text-primary); background: rgba(255,255,255,0.04); }
    .nav-link.active { color: var(--text-primary); font-weight: 600; }
    .nav-link.active::after {
      content: ''; position: absolute; bottom: -14px; left: 14px; right: 14px;
      height: 2px; background: var(--brand); border-radius: 1px;
    }
    .nav-right { display: flex; align-items: center; gap: 12px; }
    .user-pill {
      display: flex; align-items: center; gap: 10px;
      padding: 5px 14px 5px 5px; background: var(--bg-tertiary); border: 1px solid var(--border);
      border-radius: 24px; cursor: pointer; transition: border-color 0.2s;
    }
    .user-pill:hover { border-color: var(--border-light); }
    .user-pill-name { font-size: 13px; font-weight: 600; color: var(--text-primary); }
    .user-pill-role { font-size: 9px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 0.04em; }
    .signout-btn {
      background: none; border: 1px solid var(--border); color: var(--text-muted);
      padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 500;
      cursor: pointer; transition: all 0.2s; font-family: inherit;
    }
    .signout-btn:hover { border-color: rgba(239,68,68,0.3); color: var(--red-light); background: rgba(239,68,68,0.06); }

    /* ── Mobile Menu ── */
    .mobile-menu-btn {
      display: none; background: none; border: none; color: var(--text-secondary);
      cursor: pointer; padding: 8px; border-radius: 8px; transition: all 0.2s;
    }
    .mobile-menu-btn:hover { color: var(--text-primary); background: rgba(255,255,255,0.04); }
    .mobile-menu-btn svg { width: 22px; height: 22px; display: block; }
    .mobile-nav {
      display: none; position: fixed; top: 60px; left: 0; right: 0; z-index: 999;
      background: rgba(10, 10, 15, 0.98); backdrop-filter: blur(24px);
      border-bottom: 1px solid var(--border); padding: 8px 16px 16px;
    }
    .mobile-nav.open { display: block; }
    .mobile-nav a {
      display: block; padding: 12px 16px; color: var(--text-secondary); text-decoration: none;
      font-size: 15px; font-weight: 500; border-radius: 8px; transition: all 0.2s;
    }
    .mobile-nav a:hover, .mobile-nav a.active { color: var(--text-primary); background: rgba(255,255,255,0.04); }
    .mobile-nav a.active { border-left: 2px solid var(--brand); }
    .mobile-nav-footer {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px 0; margin-top: 8px; border-top: 1px solid var(--border);
    }
    .mobile-user-info { display: flex; align-items: center; gap: 10px; }
    .mobile-user-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }

    /* ── Page Layout ── */
    .dash-container { max-width: 1200px; margin: 0 auto; padding: 84px 20px 40px; position: relative; z-index: 1; }

    .dash-greeting { margin-bottom: 28px; }
    .dash-greeting h1 {
      font-size: 30px; font-weight: 800; margin-bottom: 4px;
      background: linear-gradient(135deg, #ffffff 0%, var(--text-secondary) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .dash-greeting p { color: var(--text-muted); font-size: 14px; }

    /* ── Portfolio Card ── */
    .portfolio-card {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(17,17,24,0.8) 100%);
      border: 1px solid var(--border); border-radius: 14px;
      padding: 22px; display: grid; grid-template-columns: 1fr 1px 1fr 1px 1fr; gap: 0; align-items: center;
      margin-bottom: 24px; position: relative; overflow: hidden;
    }
    .portfolio-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(220,38,38,0.3), transparent);
    }
    .portfolio-divider { background: var(--border); align-self: stretch; }
    .portfolio-section { padding: 0 20px; }
    .portfolio-section:first-child { padding-left: 4px; }
    .portfolio-section:last-child { padding-right: 4px; }
    .pf-label { font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
    .pf-value { font-size: 28px; font-weight: 800; color: var(--text-primary); line-height: 1.1; }
    .pf-sub { font-size: 12px; font-weight: 600; margin-top: 4px; }
    .pf-sub.positive { color: var(--accent-light); }
    .pf-sub.negative { color: var(--red-light); }
    .pf-sub.neutral { color: var(--text-muted); }
    .pf-goal-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px; margin-top: 8px; overflow: hidden; }
    .pf-goal-fill { height: 100%; border-radius: 3px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
    .pf-goal-fill.on-track { background: linear-gradient(90deg, var(--accent), var(--accent-light)); }
    .pf-goal-fill.behind { background: linear-gradient(90deg, #d97706, var(--yellow)); }
    .pf-goal-fill.over { background: linear-gradient(90deg, var(--accent), #6ee7b7); }
    .pf-capacity-row { display: flex; gap: 16px; margin-top: 6px; }
    .pf-cap-item { display: flex; align-items: center; gap: 4px; }
    .pf-cap-dot { width: 6px; height: 6px; border-radius: 50%; }
    .pf-cap-dot.available { background: var(--accent); }
    .pf-cap-dot.pending { background: var(--yellow); }
    .pf-cap-text { font-size: 12px; color: var(--text-secondary); }
    .pf-cap-val { font-weight: 600; color: var(--text-primary); }

    /* ── Dashboard Grid ── */
    .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
    .dash-card {
      background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 14px; padding: 20px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .dash-card:hover {
      border-color: var(--border-light);
      box-shadow: 0 4px 24px rgba(0,0,0,0.2);
    }
    .dash-card-header {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;
    }
    .dash-card-title {
      font-size: 13px; font-weight: 700; color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.04em; margin-bottom: 0;
    }
    .dash-card-badge {
      font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px;
      text-transform: uppercase; letter-spacing: 0.03em;
    }
    .badge-live { background: rgba(239,68,68,0.12); color: var(--red-light); }
    .badge-count { background: rgba(59,130,246,0.12); color: var(--blue); }
    .dash-card.full-width { grid-column: 1 / -1; }

    /* ── Today's Slate ── */
    .slate-row {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 12px; background: var(--bg-tertiary); border-radius: 10px;
      margin-bottom: 8px; transition: background 0.2s;
    }
    .slate-row:last-child { margin-bottom: 0; }
    .slate-row:hover { background: var(--bg-elevated); }
    .slate-sport-icon {
      width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center;
      justify-content: center; font-size: 18px; flex-shrink: 0;
    }
    .slate-sport-icon.nba { background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.05)); }
    .slate-sport-icon.ncaab { background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(59,130,246,0.05)); }
    .slate-sport-icon.nhl { background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(139,92,246,0.05)); }
    .slate-sport-icon.props { background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.05)); }
    .slate-info { flex: 1; }
    .slate-sport { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .slate-detail { font-size: 12px; color: var(--text-muted); }
    .slate-count {
      font-size: 20px; font-weight: 800; color: var(--text-primary); min-width: 28px; text-align: right;
    }
    .slate-empty { padding: 20px 0; text-align: center; color: var(--text-muted); font-size: 13px; }

    /* ── Quick Actions ── */
    .qa-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .qa-btn {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text-primary); text-decoration: none;
      font-size: 14px; font-weight: 600; transition: all 0.2s;
    }
    .qa-btn:hover {
      border-color: var(--border-light); background: var(--bg-elevated);
      transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .qa-icon-wrap {
      width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center;
      justify-content: center; font-size: 18px; flex-shrink: 0;
    }
    .qa-icon-wrap.red { background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.05)); }
    .qa-icon-wrap.yellow { background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.05)); }
    .qa-icon-wrap.green { background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(16,185,129,0.05)); }
    .qa-icon-wrap.blue { background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(59,130,246,0.05)); }
    .qa-label span { display: block; font-size: 11px; font-weight: 400; color: var(--text-muted); margin-top: 2px; }

    /* ── Performance Stats ── */
    .perf-row {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 0; border-bottom: 1px solid var(--border);
    }
    .perf-row:last-child { border-bottom: none; }
    .perf-label { font-size: 13px; color: var(--text-secondary); min-width: 80px; }
    .perf-bar-wrap { flex: 1; height: 8px; background: rgba(255,255,255,0.04); border-radius: 4px; overflow: hidden; }
    .perf-bar {
      height: 100%; border-radius: 4px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 2px;
    }
    .perf-bar.winning { background: linear-gradient(90deg, var(--accent), var(--accent-light)); }
    .perf-bar.losing { background: linear-gradient(90deg, #dc2626, var(--red-light)); }
    .perf-bar.neutral { background: var(--text-muted); }
    .perf-value { font-size: 13px; font-weight: 700; min-width: 90px; text-align: right; }
    .perf-value.winning { color: var(--accent-light); }
    .perf-value.losing { color: var(--red-light); }
    .perf-value.neutral { color: var(--text-muted); }
    .perf-empty { padding: 20px 0; text-align: center; color: var(--text-muted); font-size: 13px; }

    /* ── Alerts ── */
    .alert-item {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 14px; margin-bottom: 8px; border-radius: 10px;
      background: var(--bg-tertiary); border-left: 3px solid var(--border);
      transition: background 0.2s;
    }
    .alert-item:last-child { margin-bottom: 0; }
    .alert-item:hover { background: var(--bg-elevated); }
    .alert-item.alert-info { border-left-color: var(--blue); }
    .alert-item.alert-action { border-left-color: var(--yellow); }
    .alert-item.alert-success { border-left-color: var(--accent); }
    .alert-icon { font-size: 18px; flex-shrink: 0; }
    .alert-text { font-size: 13px; color: var(--text-secondary); line-height: 1.4; flex: 1; }
    .alert-text strong { color: var(--text-primary); }
    .alert-cta {
      font-size: 12px; font-weight: 600; color: var(--brand-light); text-decoration: none;
      white-space: nowrap; padding: 4px 10px; border-radius: 6px; transition: background 0.2s;
    }
    .alert-cta:hover { background: rgba(239,68,68,0.08); }

    /* ── User Avatar ── */
    .user-avatar {
      width: 30px; height: 30px; border-radius: 50%;
      background: linear-gradient(135deg, var(--brand), #b91c1c);
      color: #fff; font-weight: 700; font-size: 13px; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }

    /* ── Responsive ── */
    @media (max-width: 768px) {
      .portfolio-card { grid-template-columns: 1fr; }
      .portfolio-divider { height: 1px; width: 100%; margin: 12px 0; }
      .portfolio-section { padding: 0; }
      .pf-value { font-size: 24px; }
      .dash-grid { grid-template-columns: 1fr; }
      .qa-grid { grid-template-columns: 1fr; }
      .dash-greeting h1 { font-size: 22px; }
      .nav-links { display: none; }
      .user-pill-name, .user-pill-role { display: none; }
      .signout-btn { display: none; }
      .mobile-menu-btn { display: block; }
    }
  </style>
</head>
<body>
  <div class="page-gradient"></div>

  <header class="top-nav">
    <div class="top-nav-inner">
      <div class="nav-brand">
        <a href="dashboard-home.html">
          <span>Edge Factor <span style="color:#dc2626;">Elite</span></span>
        </a>
      </div>
      <div class="nav-links">
        <a href="dashboard-home.html" class="nav-link active">Dashboard</a>
        <a href="dashboard.html" class="nav-link">Projections</a>
        <a href="results.html" class="nav-link">Results</a>
        <a href="mybets.html" class="nav-link">My Bets</a>
      </div>
      <div class="nav-right">
        <div class="user-pill" id="user-pill">
          <div class="user-avatar" id="user-avatar"></div>
          <div>
            <div class="user-pill-name" id="user-pill-name"></div>
            <div class="user-pill-role">Free</div>
          </div>
        </div>
        <button class="signout-btn" onclick="handleSignOut()">Sign Out</button>
        <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Menu">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile Nav Drawer -->
  <nav class="mobile-nav" id="mobile-nav">
    <a href="dashboard-home.html" class="active">Dashboard</a>
    <a href="dashboard.html">Projections</a>
    <a href="results.html">Results</a>
    <a href="mybets.html">My Bets</a>
    <div class="mobile-nav-footer">
      <div class="mobile-user-info">
        <div class="user-avatar" id="mobile-avatar" style="width:28px;height:28px;font-size:12px;"></div>
        <span class="mobile-user-name" id="mobile-user-name"></span>
      </div>
      <button class="signout-btn" onclick="handleSignOut()">Sign Out</button>
    </div>
  </nav>

  <div class="dash-container">
    <!-- Greeting -->
    <div class="dash-greeting animate-in">
      <h1 id="greeting-text">Loading...</h1>
      <p id="greeting-sub"></p>
    </div>

    <!-- Portfolio Summary -->
    <div id="portfolio-card" class="animate-in"></div>

    <!-- Dashboard Grid -->
    <div class="dash-grid">
      <!-- Today's Slate -->
      <div class="dash-card animate-in">
        <div class="dash-card-header">
          <div class="dash-card-title">Today's Slate</div>
          <span class="dash-card-badge badge-count" id="slate-badge" style="display:none"></span>
        </div>
        <div id="slate-section">
          <div class="skeleton skeleton-text" style="width:80%"></div>
          <div class="skeleton skeleton-text" style="width:65%;margin-top:12px"></div>
          <div class="skeleton skeleton-text" style="width:70%;margin-top:12px"></div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="dash-card animate-in">
        <div class="dash-card-header">
          <div class="dash-card-title">Quick Actions</div>
        </div>
        <div class="qa-grid">
          <a href="dashboard.html" class="qa-btn">
            <div class="qa-icon-wrap red">&#128200;</div>
            <div class="qa-label">Games<span>Projections</span></div>
          </a>
          <a href="dashboard.html#player-props" class="qa-btn">
            <div class="qa-icon-wrap yellow">&#127942;</div>
            <div class="qa-label">Props<span>Player picks</span></div>
          </a>
          <a href="mybets.html" class="qa-btn">
            <div class="qa-icon-wrap green">&#128176;</div>
            <div class="qa-label">My Bets<span>Track & grade</span></div>
          </a>
          <a href="results.html" class="qa-btn">
            <div class="qa-icon-wrap blue">&#128202;</div>
            <div class="qa-label">Results<span>Full history</span></div>
          </a>
        </div>
      </div>

      <!-- Performance Summary -->
      <div class="dash-card animate-in">
        <div class="dash-card-header">
          <div class="dash-card-title">Performance</div>
        </div>
        <div id="perf-summary">
          <div class="skeleton skeleton-text" style="width:90%"></div>
          <div class="skeleton skeleton-text" style="width:75%;margin-top:14px"></div>
          <div class="skeleton skeleton-text" style="width:60%;margin-top:14px"></div>
        </div>
      </div>

      <!-- Today's Alerts -->
      <div class="dash-card animate-in">
        <div class="dash-card-header">
          <div class="dash-card-title">Alerts</div>
        </div>
        <div id="alerts-section">
          <div class="skeleton skeleton-text" style="width:85%"></div>
          <div class="skeleton skeleton-text" style="width:70%;margin-top:14px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + Auth + Kelly -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="auth.js"></script>
  <script src="js/betting/kellyCalculator.js"></script>
  <script>
    const RESULTS_CUTOFF = '2026-02-27';

    // ── Mobile Menu Toggle ──
    document.getElementById('mobile-menu-btn')?.addEventListener('click', () => {
      document.getElementById('mobile-nav').classList.toggle('open');
    });

    // ── Bet Settings (localStorage) ──
    function getBetSettings() {
      try { return JSON.parse(localStorage.getItem('efe_user_settings')) || {}; }
      catch { return {}; }
    }
    function getTrackedBets() {
      try { return JSON.parse(localStorage.getItem('efe_tracked_bets')) || []; }
      catch { return []; }
    }

    // ── Auth Guard ──
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.replace('index.html');
        return;
      }

      // Greeting
      const name = user.displayName || user.email.split('@')[0];
      const hour = new Date().getHours();
      const greet = hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening';
      document.getElementById('greeting-text').textContent = `${greet}, ${name.split(' ')[0]}`;

      const today = new Date();
      document.getElementById('greeting-sub').textContent = today.toLocaleDateString('en-US', {
        weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
      });

      // Populate nav user info
      const initial = name.charAt(0).toUpperCase();
      const avatarEl = document.getElementById('user-avatar');
      if (avatarEl) avatarEl.textContent = initial;
      const nameEl = document.getElementById('user-pill-name');
      if (nameEl) nameEl.textContent = name.split(' ')[0];

      // Mobile nav user info
      const mobileAvatar = document.getElementById('mobile-avatar');
      if (mobileAvatar) mobileAvatar.textContent = initial;
      const mobileNameEl = document.getElementById('mobile-user-name');
      if (mobileNameEl) mobileNameEl.textContent = name.split(' ')[0];

      renderPortfolio();
      loadSlate();
      loadPerformance();
      loadAlerts();
    });

    // ── Portfolio Summary ──
    function renderPortfolio() {
      const container = document.getElementById('portfolio-card');
      if (!container) return;

      let bankroll = 0, unitSize = 10, monthlyTarget = 500;
      if (typeof KellyCalculator !== 'undefined') {
        const s = KellyCalculator.getSettings();
        bankroll = s.bankroll || 0;
        unitSize = s.unitSize || 10;
      }
      if (!bankroll) {
        const ls = getBetSettings();
        bankroll = ls.bankroll || 0;
        unitSize = ls.unit_size || 10;
      }
      if (!bankroll && typeof userProfile !== 'undefined' && userProfile?.settings) {
        bankroll = userProfile.settings.bankroll || 0;
        unitSize = userProfile.settings.unitSize || 10;
        monthlyTarget = userProfile.settings.monthlyTarget || 500;
      }

      if (!bankroll) {
        container.innerHTML = `<div class="portfolio-card" style="text-align:center;padding:24px;">
          <div style="grid-column:1/-1;color:var(--text-muted);font-size:13px;">
            Set your bankroll in <a href="mybets.html" style="color:var(--brand-light);text-decoration:none;font-weight:600;">My Bets</a> to see your portfolio summary
          </div>
        </div>`;
        return;
      }

      const bets = getTrackedBets();
      const pendingBets = bets.filter(b => !b.result && b.status !== 'graded');
      const pendingAmount = pendingBets.reduce((sum, b) => sum + ((parseFloat(b.units) || 1) * unitSize), 0);
      const available = Math.max(0, bankroll - pendingAmount);

      const now = new Date();
      const monthStart = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-01';
      const settledBets = bets.filter(b => b.result && b.date >= monthStart);
      let monthPL = 0;
      for (const b of settledBets) {
        const stake = (parseFloat(b.units) || 1) * unitSize;
        if (b.result === 'win') {
          const odds = parseInt(b.odds) || -110;
          monthPL += odds > 0 ? stake * (odds / 100) : stake * (100 / Math.abs(odds));
        } else if (b.result === 'loss') monthPL -= stake;
      }
      const monthPct = bankroll > 0 ? ((monthPL / bankroll) * 100).toFixed(1) : '0.0';
      const plClass = monthPL > 0 ? 'positive' : monthPL < 0 ? 'negative' : 'neutral';
      const plSign = monthPL >= 0 ? '+' : '';

      const goalPct = monthlyTarget > 0 ? Math.min(100, Math.max(0, (Math.max(0, monthPL) / monthlyTarget) * 100)).toFixed(0) : 0;
      const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
      const daysLeft = Math.max(0, lastDay - now.getDate());
      const goalBarClass = goalPct >= 100 ? 'over' : goalPct >= (now.getDate() / lastDay * 100) ? 'on-track' : 'behind';

      container.innerHTML = `<div class="portfolio-card">
        <div class="portfolio-section">
          <div class="pf-label">Bankroll</div>
          <div class="pf-value">$${bankroll.toLocaleString()}</div>
          <div class="pf-sub ${plClass}">${plSign}$${Math.abs(monthPL).toFixed(0)} (${plSign}${monthPct}%) this month</div>
        </div>
        <div class="portfolio-divider"></div>
        <div class="portfolio-section">
          <div class="pf-label">Monthly Goal &middot; $${monthlyTarget}</div>
          <div class="pf-value">${goalPct}%</div>
          <div class="pf-sub neutral">${daysLeft} day${daysLeft !== 1 ? 's' : ''} left</div>
          <div class="pf-goal-bar"><div class="pf-goal-fill ${goalBarClass}" style="width:${goalPct}%"></div></div>
        </div>
        <div class="portfolio-divider"></div>
        <div class="portfolio-section">
          <div class="pf-label">Betting Capacity</div>
          <div class="pf-capacity-row">
            <div class="pf-cap-item"><div class="pf-cap-dot available"></div><span class="pf-cap-text">Available: <span class="pf-cap-val">$${available.toLocaleString()}</span></span></div>
          </div>
          <div class="pf-capacity-row">
            <div class="pf-cap-item"><div class="pf-cap-dot pending"></div><span class="pf-cap-text">Pending: <span class="pf-cap-val">$${pendingAmount.toFixed(0)}</span> (${pendingBets.length} bet${pendingBets.length !== 1 ? 's' : ''})</span></div>
          </div>
          <div class="pf-sub neutral" style="margin-top:8px">$${unitSize}/unit</div>
        </div>
      </div>`;
    }

    // ── Today's Slate ──
    async function loadSlate() {
      const container = document.getElementById('slate-section');
      const badge = document.getElementById('slate-badge');
      if (!container) return;

      const today = new Date();
      const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');

      const slate = [];
      let totalGames = 0;

      try {
        // NBA Games
        const gpResp = await fetch('game_projections.json?t=' + Date.now());
        if (gpResp.ok) {
          const gp = await gpResp.json();
          if (gp.date === todayStr && gp.games?.length > 0) {
            const bestBets = gp.games.filter(g =>
              (g.spread_conf && g.spread_conf >= 60) ||
              (g.total_conf && g.total_conf >= 60) ||
              (g.ml_conf && g.ml_conf >= 60)
            ).length;
            const firstGame = gp.games.find(g => g.commence_time);
            let timeStr = '';
            if (firstGame?.commence_time) {
              const t = new Date(firstGame.commence_time);
              timeStr = 'First tip ' + t.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            }
            slate.push({ sport: 'NBA Games', icon: '&#127936;', cls: 'nba', count: gp.games.length,
              detail: bestBets > 0 ? `${bestBets} best bet${bestBets !== 1 ? 's' : ''}` + (timeStr ? ' \u00B7 ' + timeStr : '') : timeStr || 'Projections ready' });
            totalGames += gp.games.length;
          }
        }

        // Player Props
        const propsResp = await fetch('projections.json?t=' + Date.now());
        if (propsResp.ok) {
          const props = await propsResp.json();
          if (props.date === todayStr && props.projections?.length > 0) {
            const highConf = props.projections.filter(p => p.confidence >= 70).length;
            slate.push({ sport: 'Player Props', icon: '&#127942;', cls: 'props', count: props.projections.length,
              detail: highConf > 0 ? `${highConf} high-confidence pick${highConf !== 1 ? 's' : ''}` : 'AI-powered picks' });
            totalGames += props.projections.length;
          }
        }

        // NCAAB
        const ncaabResp = await fetch('ncaab_projections.json?t=' + Date.now());
        if (ncaabResp.ok) {
          const ncaab = await ncaabResp.json();
          if (ncaab.date === todayStr && ncaab.games?.length > 0) {
            slate.push({ sport: 'NCAAB', icon: '&#127944;', cls: 'ncaab', count: ncaab.games.length,
              detail: 'College basketball' });
            totalGames += ncaab.games.length;
          }
        }

        // NHL
        const nhlResp = await fetch('nhl_projections.json?t=' + Date.now());
        if (nhlResp.ok) {
          const nhl = await nhlResp.json();
          if (nhl.date === todayStr && nhl.games?.length > 0) {
            slate.push({ sport: 'NHL', icon: '&#127954;', cls: 'nhl', count: nhl.games.length,
              detail: 'Hockey predictions' });
            totalGames += nhl.games.length;
          }
        }
      } catch (e) {}

      if (slate.length === 0) {
        container.innerHTML = '<div class="slate-empty">No projections posted yet today. Check back soon.</div>';
        return;
      }

      if (badge) {
        badge.textContent = totalGames + ' total';
        badge.style.display = '';
      }

      container.innerHTML = slate.map(s => `
        <div class="slate-row">
          <div class="slate-sport-icon ${s.cls}">${s.icon}</div>
          <div class="slate-info">
            <div class="slate-sport">${s.sport}</div>
            <div class="slate-detail">${s.detail}</div>
          </div>
          <div class="slate-count">${s.count}</div>
        </div>
      `).join('');
    }

    // ── Performance Summary ──
    async function loadPerformance() {
      const container = document.getElementById('perf-summary');
      if (!container) return;

      try {
        const [nbaResp, ncaabResp, nhlResp] = await Promise.all([
          fetch('results.json?t=' + Date.now()),
          fetch('ncaab_results.json?t=' + Date.now()),
          fetch('nhl_results.json?t=' + Date.now()),
        ]);

        const sports = [];
        for (const [resp, label] of [[nbaResp, 'NBA'], [ncaabResp, 'NCAAB'], [nhlResp, 'NHL']]) {
          if (!resp.ok) continue;
          const data = await resp.json();
          const days = (data.days || []).filter(d => d.date >= RESULTS_CUTOFF);
          if (days.length === 0) continue;

          let w = 0, l = 0;
          for (const d of days) {
            for (const cat of ['moneylines', 'spreads', 'totals']) {
              w += d[cat]?.wins || 0;
              l += d[cat]?.losses || 0;
            }
          }
          sports.push({ label, wins: w, losses: l, days: days.length });
        }

        if (sports.length === 0) {
          container.innerHTML = '<div class="perf-empty">No graded results yet. Results will appear after today\'s games finish.</div>';
          return;
        }

        let totalW = 0, totalL = 0;
        let html = '';
        for (const s of sports) {
          const t = s.wins + s.losses;
          const pct = t > 0 ? (s.wins / t * 100).toFixed(1) : '0.0';
          const cls = t === 0 ? 'neutral' : parseFloat(pct) > 53 ? 'winning' : parseFloat(pct) < 47 ? 'losing' : 'neutral';
          html += `<div class="perf-row">
            <span class="perf-label">${s.label}</span>
            <div class="perf-bar-wrap"><div class="perf-bar ${cls}" style="width:${Math.max(2, parseFloat(pct))}%"></div></div>
            <span class="perf-value ${cls}">${s.wins}-${s.losses} (${pct}%)</span>
          </div>`;
          totalW += s.wins;
          totalL += s.losses;
        }
        const totalT = totalW + totalL;
        const totalPct = totalT > 0 ? (totalW / totalT * 100).toFixed(1) : '0.0';
        const totalCls = totalT === 0 ? 'neutral' : parseFloat(totalPct) > 53 ? 'winning' : parseFloat(totalPct) < 47 ? 'losing' : 'neutral';
        html += `<div class="perf-row" style="border-top:1px solid var(--border-light);margin-top:4px;padding-top:14px;">
          <span class="perf-label" style="font-weight:700;color:var(--text-primary);">Overall</span>
          <div class="perf-bar-wrap"><div class="perf-bar ${totalCls}" style="width:${Math.max(2, parseFloat(totalPct))}%"></div></div>
          <span class="perf-value ${totalCls}">${totalW}-${totalL} (${totalPct}%)</span>
        </div>`;

        container.innerHTML = html;
      } catch (e) {
        container.innerHTML = '<div class="perf-empty">Unable to load performance data</div>';
      }
    }

    // ── Today's Alerts ──
    async function loadAlerts() {
      const container = document.getElementById('alerts-section');
      if (!container) return;

      const alerts = [];
      const today = new Date();
      const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');

      try {
        const gpResp = await fetch('game_projections.json?t=' + Date.now());
        if (gpResp.ok) {
          const gp = await gpResp.json();
          if (gp.date === todayStr && gp.games?.length > 0) {
            alerts.push({ type: 'info', icon: '&#128200;',
              text: `<strong>${gp.games.length} NBA game projections</strong> ready for today`,
              cta: 'View', href: 'dashboard.html' });
          }
        }

        const propsResp = await fetch('projections.json?t=' + Date.now());
        if (propsResp.ok) {
          const props = await propsResp.json();
          if (props.date === todayStr && props.projections?.length > 0) {
            alerts.push({ type: 'info', icon: '&#127942;',
              text: `<strong>${props.projections.length} player prop projections</strong> available`,
              cta: 'View', href: 'dashboard.html#player-props' });
          }
        }

        const bets = getTrackedBets();
        const pending = bets.filter(b => !b.result && b.status !== 'graded');
        if (pending.length > 0) {
          alerts.push({ type: 'action', icon: '&#9200;',
            text: `You have <strong>${pending.length} pending bet${pending.length !== 1 ? 's' : ''}</strong> awaiting results`,
            cta: 'Track', href: 'mybets.html' });
        }
      } catch (e) {}

      if (alerts.length === 0) {
        alerts.push({ type: 'success', icon: '&#9989;',
          text: 'All caught up! Check back when new projections are posted.', cta: null });
      }

      container.innerHTML = alerts.map(a => `
        <div class="alert-item alert-${a.type}">
          <span class="alert-icon">${a.icon}</span>
          <span class="alert-text">${a.text}</span>
          ${a.cta ? `<a href="${a.href}" class="alert-cta">${a.cta} &rarr;</a>` : ''}
        </div>
      `).join('');
    }
  </script>
</body>
</html>
